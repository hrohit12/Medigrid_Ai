<!DOCTYPE html>
<html class="light" lang="en">

<head>

    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>MediGrid AI | Professional Medical Analysis</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@600;700;800&family=Inter:wght@400;500;600&family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
        rel="stylesheet" />
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- jsPDF Script -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#10b981",
                        secondary: "#3b82f6",
                        "background-light": "#f8fafc",
                        "background-dark": "#0f172a",
                    },
                    fontFamily: {
                        sans: ["Inter", "sans-serif"],
                        display: ["Plus Jakarta Sans", "sans-serif"],
                    },
                },
            },
        };
    </script>
    <style>
        .material-symbols-rounded {
            font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .dark .glass {
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* ===== PREMIUM UI ANIMATIONS ===== */

        /* Global Smooth Transitions */
        * {
            transition: all 0.25s cubic-bezier(.4, 0, .2, 1);
        }

        /* Hero Upload Float Animation */
        @keyframes floatPulse {

            0%,
            100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-6px);
            }
        }

        .upload-animate {
            animation: floatPulse 4s ease-in-out infinite;
        }

        /* Modal Enter Animation */
        @keyframes modalEnter {
            from {
                opacity: 0;
                transform: scale(.95) translateY(20px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .animate-modal {
            animation: modalEnter .35s cubic-bezier(.4, 0, .2, 1);
        }

        /* Map Gradient Border Glow */
        @keyframes borderMove {
            0% {
                background-position: 0% 50%;
            }

            100% {
                background-position: 200% 50%;
            }
        }

        .map-glow::before {
            content: '';
            position: absolute;
            inset: -2px;
            background: linear-gradient(90deg, #10b981, #3b82f6, #10b981);
            background-size: 200% 200%;
            animation: borderMove 6s linear infinite;
            border-radius: 1.5rem;
            opacity: 0.3;
            z-index: -1;
        }

        /* Loader Pulse Glow */
        @keyframes loaderPulse {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.7;
                transform: scale(1.05);
            }
        }

        .loader-glow {
            animation: loaderPulse 2s ease-in-out infinite;
        }

        /* Toast Fade Up Animation */
        @keyframes toastFadeUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .toast {
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast.hide {
            opacity: 0;
            transform: translateY(-10px);
        }

        /* Tab Indicator Slide */
        .tab-indicator {
            transition: all 0.3s cubic-bezier(.4, 0, .2, 1);
        }

        /* Premium Glassmorphism Classes */
        .glass-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(226, 232, 240, 0.6);
            box-shadow: 0 25px 50px -12px rgba(226, 232, 240, 0.4);
        }

        .dark .glass-card {
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid rgba(51, 65, 85, 0.4);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4);
        }

        /* Confidence Badge Shimmer */
        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }

            100% {
                background-position: 200% 0;
            }
        }

        .confidence-badge {
            background: linear-gradient(90deg, #10b981 0%, #34d399 50%, #10b981 100%);
            background-size: 200% 100%;
            animation: shimmer 3s ease-in-out infinite;
        }

        /* ===== ENTERPRISE MEDICAL SAAS ANIMATIONS ===== */

        /* Skeleton Loading */
        @keyframes skeleton {
            0% {
                background-position: -200% 0;
            }

            100% {
                background-position: 200% 0;
            }
        }

        .skeleton {
            background: linear-gradient(90deg,
                    rgba(226, 232, 240, 0.2) 0%,
                    rgba(226, 232, 240, 0.4) 50%,
                    rgba(226, 232, 240, 0.2) 100%);
            background-size: 200% 100%;
            animation: skeleton 1.5s ease-in-out infinite;
        }

        .dark .skeleton {
            background: linear-gradient(90deg,
                    rgba(51, 65, 85, 0.2) 0%,
                    rgba(51, 65, 85, 0.4) 50%,
                    rgba(51, 65, 85, 0.2) 100%);
        }

        /* Success Check Animation */
        @keyframes checkmark {
            0% {
                stroke-dashoffset: 100;
                opacity: 0;
            }

            50% {
                opacity: 1;
            }

            100% {
                stroke-dashoffset: 0;
                opacity: 1;
            }
        }

        .check-circle {
            animation: checkmark 0.6s ease-out forwards;
        }

        @keyframes successPulse {

            0%,
            100% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.05);
                opacity: 0.9;
            }
        }

        .success-animation {
            animation: successPulse 0.5s ease-out;
        }

        /* Typing Indicator */
        @keyframes typing {

            0%,
            60%,
            100% {
                transform: translateY(0);
            }

            30% {
                transform: translateY(-8px);
            }
        }

        .typing-dot {
            animation: typing 1.4s ease-in-out infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        /* Pulse Ring (for pharmacy marker) */
        @keyframes pulseRing {
            0% {
                transform: scale(0.8);
                opacity: 1;
            }

            50% {
                transform: scale(1.2);
                opacity: 0.5;
            }

            100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }

        .pulse-ring {
            animation: pulseRing 2s ease-out infinite;
        }

        /* Progress Bar Fill */
        @keyframes progressFill {
            from {
                width: 0%;
            }

            to {
                width: var(--progress-width, 94%);
            }
        }

        .progress-fill {
            animation: progressFill 1.2s ease-out forwards;
        }

        /* Fade Slide (for tab switching) */
        @keyframes fadeSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-slide-in {
            animation: fadeSlideIn 0.4s ease-out;
        }

        /* Background Gradient Drift */
        @keyframes gradientDrift {

            0%,
            100% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }
        }

        .gradient-drift {
            background-size: 200% 200%;
            animation: gradientDrift 15s ease infinite;
        }

        /* Bell Ring Animation */
        @keyframes bellRing {

            0%,
            100% {
                transform: rotate(0deg);
            }

            10%,
            30% {
                transform: rotate(-10deg);
            }

            20%,
            40% {
                transform: rotate(10deg);
            }
        }

        .bell-ring {
            animation: bellRing 0.8s ease-in-out;
        }

        /* AI Avatar Pulse */
        @keyframes avatarPulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            }

            50% {
                box-shadow: 0 0 0 8px rgba(16, 185, 129, 0);
            }
        }

        .avatar-pulse {
            animation: avatarPulse 2s ease-out infinite;
        }

        /* Card Lift Hover */
        .card-lift {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card-lift:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1),
                0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .dark .card-lift:hover {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.4),
                0 10px 10px -5px rgba(0, 0, 0, 0.2);
        }

        .card-lift:active {
            transform: scale(0.98) translateY(-4px);
        }

        /* Confidence Indicator */
        .confidence-bar {
            position: relative;
            height: 4px;
            background: rgba(226, 232, 240, 0.3);
            border-radius: 2px;
            overflow: hidden;
        }

        .confidence-bar::after {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background: linear-gradient(90deg, #10b981, #34d399);
            border-radius: 2px;
            width: var(--confidence, 94%);
            animation: progressFill 1.2s ease-out;
        }

        /* Status Indicator Styles */
        .status-safe {
            background: linear-gradient(135deg, #10b981, #059669);
            box-shadow: 0 4px 14px 0 rgba(16, 185, 129, 0.39);
        }

        .status-caution {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            box-shadow: 0 4px 14px 0 rgba(245, 158, 11, 0.39);
        }

        .status-critical {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            box-shadow: 0 4px 14px 0 rgba(239, 68, 68, 0.39);
        }

        /* Accent Bar for Medicine Cards */
        .accent-bar {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(180deg, #10b981, #3b82f6);
            border-radius: 4px 0 0 4px;
        }

        /* Smooth Auto Scroll */
        .smooth-scroll {
            scroll-behavior: smooth;
        }

        .spin {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #333;
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            z-index: 5000;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            font-size: 0.875rem;
            font-weight: 500;
        }

        .animate-fade-in {
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #e2e8f0;
            border-radius: 10px;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #334155;
        }

        /* Leaflet Map Styles */
        #map {
            height: 400px;
            width: 100%;
            border-radius: 1rem;
            z-index: 1;
        }

        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            font-family: 'Inter', sans-serif;
        }

        .leaflet-popup-content {
            margin: 12px;
            font-size: 12px;
            line-height: 1.5;
        }

        /* Responsive Sidebar Drawer */
        @media (max-width: 1023px) {
            .sidebar-drawer {
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
            }

            .sidebar-drawer.open {
                transform: translateX(0);
            }

            .chat-drawer {
                transform: translateX(100%);
                transition: transform 0.3s ease-in-out;
            }

            .chat-drawer.open {
                transform: translateX(0);
            }
        }


        html,
        body {
            height: 100%;
            margin: 0;
        }

        .app-wrapper {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        main {
            flex: 1;
        }

        .footer {
            width: 100%;
            padding: 24px 0;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: 'Inter', sans-serif;
            color: #1e293b;
            transition: color 0.3s ease;
        }

        .dark .footer {
            color: #ffffff;
        }

        .footer h3 {
            font-weight: 700;
            font-size: 16px;
            margin: 0 0 8px 0;
        }

        .footer p {
            font-size: 14px;
            margin: 0 0 20px 0;
        }

        .social-icons {
            display: flex;
            gap: 16px;
            align-items: center;
            justify-content: center;
        }

        .social-btn {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .dark .social-btn {
            background: #1e293b;
            box-shadow: none;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .social-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .dark .social-btn:hover {
            box-shadow: 0 0 15px rgba(226, 232, 240, 0.15);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .social-btn svg {
            fill: #1e293b;
            transition: fill 0.3s ease;
        }

        .dark .social-btn svg {
            fill: #ffffff;
        }
    </style>
</head>

<body
    class="bg-gradient-to-br from-slate-50 via-white to-emerald-50 dark:from-slate-950 dark:via-slate-900 dark:to-slate-950 text-slate-900 dark:text-slate-100 font-sans">
    <div class="app-wrapper">
        <input type="hidden" id="apiUrl" value="/data_extraction">
        <input type="file" id="hiddenFileInput" accept="image/*" class="hidden">

        <!-- Header -->
        <header
            class="h-16 border-b border-slate-200 dark:border-slate-800 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md flex items-center justify-between px-4 md:px-6 z-40">
            <div class="flex items-center gap-3">
                <button onclick="toggleSidebar('left')"
                    class="lg:hidden p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg">
                    <span class="material-symbols-rounded">menu</span>
                </button>
                <div class="flex items-center gap-2">
                    <div
                        class="w-8 h-8 md:w-10 md:h-10 bg-primary rounded-xl flex items-center justify-center shadow-lg shadow-primary/20">
                        <span class="material-symbols-rounded text-white text-xl md:text-2xl">medical_services</span>
                    </div>
                    <h1 class="font-display text-lg md:text-xl font-extrabold tracking-tight">MediGrid <span
                            class="text-primary">AI</span></h1>
                </div>
            </div>

            <div class="flex items-center gap-2 md:gap-4">
                <div id="locationBadge" title="Current Area Locked"
                    class="hidden sm:flex items-center gap-1 sm:gap-2 px-2 py-1 sm:px-3 sm:py-1.5 bg-slate-100 dark:bg-slate-800 rounded-full border border-slate-200 dark:border-slate-700 text-[10px] sm:text-xs text-slate-500 whitespace-nowrap relative">
                    <span class="material-symbols-rounded text-primary text-sm flex-shrink-0">location_on</span>
                    <span id="locationTxt" class="hidden min-[400px]:inline">Locating...</span>
                    <!-- Green indicator dot for extra-small screens (icon-only mode) -->
                    <span
                        class="absolute -top-0.5 -right-0.5 min-[400px]:hidden w-2 h-2 bg-emerald-500 rounded-full border border-white dark:border-slate-800"></span>
                </div>
                <!-- STEP 4: Secure Context Badge -->
                <div id="secureContextBadge" tabindex="0"
                    class="hidden sm:flex items-center gap-1 sm:gap-2 px-2 py-1 sm:px-3 sm:py-1.5 rounded-full border text-[10px] sm:text-xs whitespace-nowrap relative group/secure cursor-help transition-colors">
                    <span class="material-symbols-rounded text-sm flex-shrink-0" id="secureIcon">shield</span>
                    <span id="secureTxt"
                        class="hidden min-[400px]:inline border-b border-dashed border-current">Checking...</span>

                    <!-- Privacy Tooltip -->
                    <div
                        class="absolute top-full mt-3 right-0 md:right-auto md:left-1/2 md:-translate-x-1/2 w-[220px] p-3 text-[10px] leading-relaxed text-slate-600 dark:text-slate-300 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl shadow-xl opacity-0 invisible group-hover/secure:opacity-100 group-hover/secure:visible group-focus/secure:opacity-100 group-focus/secure:visible focus-within:opacity-100 focus-within:visible transition-all duration-300 transform scale-95 group-hover/secure:scale-100 group-focus/secure:scale-100 z-50 pointer-events-none text-left whitespace-normal">
                        <div class="flex items-center gap-2 mb-1.5">
                            <div
                                class="w-6 h-6 rounded-lg bg-emerald-50 dark:bg-emerald-900/30 flex items-center justify-center">
                                <span class="material-symbols-rounded text-emerald-500 text-[14px]">shield_locked</span>
                            </div>
                            <span class="font-bold text-slate-800 dark:text-white">Secure Processing</span>
                        </div>
                        Your prescription is processed securely. Data is not stored unless you manually save it.
                    </div>
                </div>
                <button onclick="document.documentElement.classList.toggle('dark')"
                    class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full transition-colors">
                    <span class="material-symbols-rounded">dark_mode</span>
                </button>
            </div>
        </header>

        <div class="flex-1 flex overflow-hidden relative">
            <!-- Overlay for mobile drawers -->
            <div id="drawerOverlay" onclick="closeAllDrawers()"
                class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-30 hidden lg:hidden transition-opacity duration-300 opacity-0">
            </div>

            <!-- Left Sidebar (Medical Context) -->
            <aside id="leftSidebar"
                class="sidebar-drawer fixed lg:static inset-y-0 left-0 w-72 bg-white dark:bg-slate-900 border-r border-slate-200 dark:border-slate-800 flex flex-col z-40 lg:z-0">
                <div class="p-6 space-y-8 overflow-y-auto flex-1">
                    <!-- Location -->
                    <div class="space-y-3">
                        <label class="text-[10px] font-bold uppercase tracking-widest text-slate-400">Location
                            Services</label>
                        <div
                            class="p-4 rounded-2xl bg-blue-50/50 dark:bg-blue-900/10 border border-blue-100 dark:border-blue-900/20">
                            <p class="text-[11px] text-blue-600 dark:text-blue-400 leading-relaxed font-medium">To find
                                nearby pharmacies, please enable your device location.</p>
                        </div>
                        <button id="locBtn" onclick="requestRealLocation()"
                            class="w-full flex items-center justify-center gap-2 bg-slate-100 dark:bg-slate-800 hover:bg-primary/10 hover:text-primary p-3 rounded-xl transition-all font-bold text-xs">
                            <span class="material-symbols-rounded text-sm">my_location</span>
                            Find Pharmacies
                        </button>
                    </div>

                    <!-- Settings -->
                    <div class="space-y-3">
                        <label class="text-[10px] font-bold uppercase tracking-widest text-slate-400">Settings</label>
                        <button onclick="confirmRestartTour()"
                            class="w-full flex items-center justify-center gap-2 bg-slate-100 dark:bg-slate-800 hover:bg-primary/10 hover:text-primary p-3 rounded-xl transition-all font-bold text-xs">
                            <span class="material-symbols-rounded text-sm">restart_alt</span>
                            Restart Tour
                        </button>
                    </div>

                    <!-- Disclaimer -->
                    <div
                        class="p-4 rounded-2xl bg-rose-50/50 dark:bg-rose-900/10 border border-rose-100 dark:border-rose-900/20 text-[10px] italic opacity-60">
                        <div class="flex items-center gap-2 mb-1.5 not-italic opacity-100 text-rose-500 font-bold">
                            <span class="material-symbols-rounded text-sm">warning</span>
                            Disclaimer
                        </div>
                        Informational support only. Consult a doctor for any medication changes.
                    </div>
                </div>


            </aside>

            <!-- Main Workspace -->
            <main class="flex-1 overflow-y-auto p-4 md:p-6 lg:p-10 flex flex-col items-center">
                <div class="w-full max-w-4xl space-y-10 py-6 animate-fade-in">
                    <div class="text-center space-y-3">
                        <h2 class="font-display text-2xl md:text-4xl font-extrabold tracking-tight dark:text-white">
                            Professional <span class="text-primary">Medical</span> Analysis</h2>
                        <p class="text-slate-500 dark:text-slate-400 max-w-lg mx-auto text-sm md:text-base">Upload
                            tablets
                            prescriptions to get instant AI-powered medication analysis and safety warnings.</p>
                    </div>

                    <!-- Upload Card -->
                    <div id="uploadCardBtn" class="relative group" onclick="triggerUpload()">
                        <div
                            class="absolute -inset-1 bg-gradient-to-r from-primary to-secondary rounded-3xl blur opacity-20 group-hover:opacity-40 transition duration-1000">
                        </div>
                        <div
                            class="relative glass-card border-2 border-dashed border-slate-200/60 dark:border-slate-700/40 rounded-3xl p-8 md:p-16 text-center cursor-pointer transition-all duration-500 hover:border-primary hover:-translate-y-2 hover:shadow-2xl active:scale-95">
                            <div class="space-y-4">
                                <div
                                    class="upload-animate w-16 h-16 md:w-20 md:h-20 bg-gradient-to-br from-primary to-blue-600 rounded-full flex items-center justify-center mx-auto group-hover:scale-110 transition-transform duration-500 shadow-lg shadow-primary/30">
                                    <span
                                        class="material-symbols-rounded text-3xl md:text-4xl text-white font-light">cloud_upload</span>
                                </div>
                                <div class="space-y-1">
                                    <h3 class="font-display text-lg md:text-xl font-bold">Drag & Drop Prescription</h3>
                                    <p class="text-sm text-slate-400">Supported formats: JPG, PNG, WEBP (Max 10MB)</p>
                                </div>
                                <button
                                    class="bg-primary text-white px-8 py-3 rounded-2xl font-bold text-sm shadow-xl shadow-primary/20 hover:shadow-primary/40 transition-all">Select
                                    Image</button>
                            </div>
                        </div>
                    </div>

                    <!-- Camera Scan Button (Mobile First) -->
                    <div class="relative group w-full md:w-3/4 lg:w-2/3 mx-auto mt-2 mb-6">
                        <div
                            class="absolute -inset-1 bg-gradient-to-r from-primary to-secondary rounded-2xl blur opacity-30 group-hover:opacity-60 transition duration-500">
                        </div>
                        <button id="scanPrescriptionBtn" onclick="triggerScan()"
                            style="background: linear-gradient(135deg, rgba(16,185,129,0.9), rgba(59,130,246,0.9)); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);"
                            class="relative w-full glass-card text-white border border-white/20 dark:border-white/10 shadow-xl rounded-2xl p-4 flex items-center justify-center gap-3 transition-all duration-300 hover:-translate-y-1 hover:shadow-2xl hover:shadow-primary/40 active:scale-95">
                            <span class="material-symbols-rounded text-2xl">camera_alt</span>
                            <span class="font-display font-bold text-base md:text-lg tracking-wide">Scan
                                Prescription</span>
                        </button>
                        <input type="file" id="cameraInput" accept="image/*" capture="environment" class="hidden">
                        <input type="file" id="desktopScanInput" accept="image/*" class="hidden">
                    </div>

                    <div class="flex justify-center">
                        <button onclick="toggleHistory()"
                            class="text-xs font-bold text-slate-400 hover:text-primary flex items-center gap-2 transition-colors">
                            <span class="material-symbols-rounded text-sm">history</span>
                            View Previous Analyses
                        </button>
                    </div>

                    <!-- Results Display -->
                    <div id="resultsContainer" class="hidden space-y-8 mt-6" style="display: none;">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Source Card -->
                            <div
                                class="glass-card rounded-3xl border border-slate-200/60 dark:border-slate-700/40 overflow-hidden shadow-xl hover:shadow-2xl hover:-translate-y-1 transition-all duration-300">
                                <div
                                    class="p-4 border-b border-slate-50 dark:border-slate-800 flex items-center justify-between">
                                    <h3 class="text-xs font-bold uppercase tracking-widest opacity-50">Source Document
                                    </h3>
                                    <span class="material-symbols-rounded text-sm opacity-30">visibility</span>
                                </div>
                                <div
                                    class="aspect-[4/3] relative bg-slate-50 dark:bg-slate-950 flex items-center justify-center">
                                    <img id="dashboardImg" class="w-full h-full object-contain p-2" src="" />
                                </div>
                            </div>

                            <!-- Data Card -->
                            <div
                                class="glass-card rounded-3xl border border-slate-200/60 dark:border-slate-700/40 overflow-hidden shadow-xl hover:shadow-2xl hover:-translate-y-1 transition-all duration-300 flex flex-col">
                                <div class="p-4 border-b border-slate-50 dark:border-slate-800 flex items-center gap-2">
                                    <button id="tabDataBtn" onclick="toggleTab('data')"
                                        class="text-xs font-bold px-4 py-2 rounded-lg bg-primary/10 text-primary">Medications</button>
                                    <button id="tabWarnBtn" onclick="toggleTab('warn')"
                                        class="text-xs font-bold px-4 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 flex items-center gap-2">
                                        Safety Warns
                                        <span id="warnCount"
                                            class="hidden w-5 h-5 bg-rose-500 text-white rounded-full flex items-center justify-center text-[8px]">0</span>
                                    </button>
                                </div>
                                <div class="p-6 flex-1 overflow-y-auto max-h-[400px]">
                                    <div id="patientData"
                                        class="mb-6 grid grid-cols-2 gap-4 text-xs font-medium opacity-60 border-b border-slate-50 dark:border-slate-800 pb-4">
                                    </div>
                                    <div id="tabData" class="space-y-4">
                                        <div class="med-list space-y-4">

                                        </div>
                                    </div>
                                    <div id="tabWarn" class="hidden space-y-4">
                                        <div class="warn-list space-y-3"></div>
                                    </div>
                                </div>
                                <div id="actionButtons"
                                    class="p-4 bg-slate-50 dark:bg-slate-950 border-t border-slate-100 dark:border-slate-800 flex gap-2"
                                    style="display: none;">
                                    <button onclick="generateMedicalReport()"
                                        class="flex-1 bg-white dark:bg-slate-900 border-2 border-primary text-primary p-3 rounded-2xl text-[10px] font-bold flex items-center justify-center gap-2 shadow-sm transition-all duration-300 hover:-translate-y-[2px] hover:shadow-lg hover:shadow-primary/20">
                                        <span
                                            class="material-symbols-rounded text-rose-500 text-sm">picture_as_pdf</span>
                                        Download
                                        Medical Report
                                    </button>
                                    <button onclick="saveToDb()"
                                        class="flex-1 bg-primary text-white p-3 rounded-xl text-[10px] font-bold flex items-center justify-center gap-2 shadow-lg shadow-primary/20">
                                        <span class="material-symbols-rounded text-sm">save</span> Archive
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pharmacy Map Section -->
                <div id="mapContainer" class="hidden w-full max-w-4xl space-y-6 animate-fade-in">
                    <div
                        class="glass-card rounded-3xl border border-slate-200/60 dark:border-slate-700/40 overflow-hidden shadow-xl relative map-glow">
                        <div
                            class="p-4 border-b border-slate-50 dark:border-slate-800 flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <span class="material-symbols-rounded text-primary">local_pharmacy</span>
                                <h3 class="text-xs font-bold uppercase tracking-widest opacity-50">Nearby Pharmacies
                                </h3>
                            </div>
                            <span class="material-symbols-rounded text-sm opacity-30">map</span>
                        </div>
                        <div class="px-6 pt-4 pb-2 border-b border-slate-50 dark:border-slate-800">
                            <div class="flex items-center justify-center gap-2">
                                <button id="btnDriving" onclick="setTravelMode('driving')"
                                    class="flex-1 flex items-center justify-center gap-2 px-4 py-2 rounded-xl bg-primary text-white text-xs font-bold shadow-sm transition-all">
                                    <span class="material-symbols-rounded text-sm">directions_car</span>
                                    Driving
                                </button>
                                <button id="btnWalking" onclick="setTravelMode('walking')"
                                    class="flex-1 flex items-center justify-center gap-2 px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 text-xs font-bold transition-all">
                                    <span class="material-symbols-rounded text-sm">directions_walk</span>
                                    Walking
                                </button>
                            </div>
                        </div>
                        <div class="p-6">
                            <div id="map"></div>
                            <p class="text-[10px] text-slate-400 text-center mt-3 italic">
                                Medicine availability may vary. Please call ahead to confirm.
                            </p>
                        </div>
                    </div>
                </div>

                <div class="h-10"></div>
            </main>



            <!-- Mobile Chat Backdrop -->
            <div id="chatOverlay" onclick="toggleChatWidget()"
                class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-40 hidden md:hidden transition-opacity duration-300 opacity-0 pointer-events-none">
            </div>

            <!-- Floating Chat Widget -->
            <div id="chatWidget"
                class="fixed bottom-24 right-4 md:right-8 z-50 flex flex-col items-end transition-all duration-500 ease-[cubic-bezier(0.34,1.56,0.64,1)] translate-y-[100%] opacity-0 pointer-events-none">
                <!-- Chat Window -->
                <div
                    class="glass-card w-[calc(100vw-32px)] md:w-[380px] h-[550px] max-h-[70vh] rounded-3xl overflow-hidden flex flex-col shadow-2xl border border-slate-200/60 dark:border-slate-700/40 mb-4 bg-white/90 dark:bg-slate-900/90">

                    <div
                        class="p-4 border-b border-slate-100/50 dark:border-slate-800/50 flex items-center justify-between bg-gradient-to-r from-primary/10 to-transparent">
                        <div class="flex items-center gap-3">
                            <div
                                class="w-10 h-10 rounded-xl bg-gradient-to-br from-primary to-blue-500 flex items-center justify-center shadow-lg shadow-primary/20">
                                <span class="material-symbols-rounded text-white text-lg">smart_toy</span>
                            </div>
                            <div>
                                <h3
                                    class="text-sm font-bold font-display tracking-tight text-slate-800 dark:text-white">
                                    MediAssist AI</h3>
                                <p
                                    class="text-[10px] text-emerald-500 font-bold flex items-center gap-1.5 uppercase tracking-wider">
                                    <span
                                        class="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-pulse shadow-[0_0_8px_rgba(16,185,129,0.8)]"></span>
                                    Online Now
                                </p>
                            </div>
                        </div>
                        <button onclick="toggleChatWidget()"
                            class="w-8 h-8 rounded-full hover:bg-slate-200/50 dark:hover:bg-slate-800/50 flex items-center justify-center transition-colors">
                            <span class="material-symbols-rounded text-slate-500">close</span>
                        </button>
                    </div>

                    <!-- Chat Box -->
                    <div id="chatBox"
                        class="flex-1 overflow-y-auto p-5 space-y-5 bg-slate-50/30 dark:bg-slate-950/30 scroll-smooth">
                        <div class="flex gap-3 max-w-[90%]">
                            <div
                                class="w-8 h-8 rounded-xl bg-gradient-to-br from-primary/20 to-blue-500/20 flex items-center justify-center shrink-0 border border-primary/10">
                                <span class="material-symbols-rounded text-primary text-[16px]">smart_toy</span>
                            </div>
                            <div
                                class="bg-white dark:bg-slate-800 p-3.5 rounded-2xl rounded-tl-none shadow-sm border border-slate-200/50 dark:border-slate-700/50">
                                <p
                                    class="text-xs font-medium opacity-90 leading-relaxed text-slate-700 dark:text-slate-200">
                                    Hello! I am your MediGrid assistant. I have all medical information and nearby
                                    hospital
                                    updates ready. Ask me anything!</p>
                            </div>
                        </div>
                    </div>

                    <!-- Chat Input -->
                    <div
                        class="p-4 bg-white/50 dark:bg-slate-900/50 backdrop-blur-md border-t border-slate-100/50 dark:border-slate-800/50">
                        <div
                            class="flex items-center gap-2 bg-white dark:bg-slate-800 p-2 rounded-2xl border border-slate-200 dark:border-slate-700 transition-all focus-within:ring-2 focus-within:ring-primary/20 focus-within:border-primary/30 shadow-inner">
                            <input id="chatInput" type="text" placeholder="Type your medical query..."
                                class="flex-1 bg-transparent border-none focus:ring-0 text-xs font-medium px-3 py-1 text-slate-700 dark:text-white placeholder-slate-400"
                                onkeypress="if(event.key==='Enter') sendChat()" />
                            <button onclick="startVoiceInput()"
                                class="w-8 h-8 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700 flex items-center justify-center transition-colors text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">
                                <span class="material-symbols-rounded text-sm">mic</span>
                            </button>
                            <button onclick="sendChat()"
                                class="w-9 h-9 rounded-xl bg-gradient-to-br from-primary to-emerald-600 text-white flex items-center justify-center shadow-lg shadow-primary/20 hover:shadow-primary/40 hover:-translate-y-0.5 active:scale-95 transition-all">
                                <span class="material-symbols-rounded text-sm">send</span>
                            </button>
                        </div>
                        ```
                    </div>
                </div>
            </div>

            <!-- Floating Action Button (Trigger) -->
            <button id="chatFabBtn" onclick="toggleChatWidget()"
                class="fixed bottom-6 right-4 md:bottom-8 md:right-8 z-50 w-14 h-14 rounded-full bg-gradient-to-r from-primary to-secondary text-white shadow-2xl shadow-primary/40 flex items-center justify-center hover:scale-105 active:scale-95 transition-all group border border-white/20">
                <!-- Tooltip -->
                <div id="chatTooltip"
                    class="absolute right-[calc(100%+16px)] px-3 py-1.5 bg-slate-800 dark:bg-slate-700 text-white text-xs font-bold rounded-xl whitespace-nowrap opacity-0 pointer-events-none group-hover:opacity-100 transition-opacity duration-300 shadow-xl shadow-slate-900/20 border border-slate-700/50 flex items-center gap-1.5 hidden md:flex">
                    Need help? <span class="material-symbols-rounded text-sm text-emerald-400">front_hand</span>
                </div>
                <div
                    class="absolute inset-0 rounded-full border-2 border-white/20 animate-ping opacity-20 group-hover:opacity-40">
                </div>
                <span class="material-symbols-rounded text-2xl transition-transform duration-300 pointer-events-none"
                    id="chatFabIcon">chat</span>
                <span id="chatUnreadBadge"
                    class="absolute -top-1 -right-1 w-5 h-5 bg-rose-500 text-white text-[10px] font-bold rounded-full flex items-center justify-center border-2 border-white dark:border-slate-800 hidden transform scale-0 transition-transform duration-300 shadow-sm pointer-events-none">0</span>
            </button>
        </div>

        <!-- Onboarding Tour Overlay: Injected dynamically via JS to ensure clean DOM -->

        <!-- Modals -->
        <!-- Restart Tour Modal -->
        <div id="restartTourModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
            <div class="absolute inset-0 bg-slate-950/40 backdrop-blur-sm" onclick="cancelRestartTour()"></div>
            <div
                class="relative glass-card animate-modal w-full max-w-sm rounded-3xl shadow-2xl overflow-hidden flex flex-col p-6 text-center border border-slate-200/60 dark:border-slate-700/40">
                <div class="w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="material-symbols-rounded text-3xl text-primary">restart_alt</span>
                </div>
                <h3 class="font-display text-lg font-bold text-slate-900 dark:text-white mb-2">Restart Onboarding?</h3>
                <p class="text-sm text-slate-500 dark:text-slate-400 mb-6">Are you sure you want to view the interactive
                    walkthrough again?</p>
                <div class="flex gap-3">
                    <button onclick="cancelRestartTour()"
                        class="flex-1 px-4 py-3 rounded-xl bg-slate-100 dark:bg-slate-800 text-sm font-bold text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">Cancel</button>
                    <button onclick="restartTour()"
                        class="flex-1 px-4 py-3 rounded-xl bg-primary text-white text-sm font-bold shadow-lg shadow-primary/30 hover:shadow-primary/50 hover:-translate-y-0.5 transition-all">Yes,
                        Restart</button>
                </div>
            </div>
        </div>
        <div id="historyModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
            <div class="absolute inset-0 bg-slate-950/40 backdrop-blur-sm" onclick="toggleHistory()"></div>
            <div
                class="relative glass-card animate-modal w-full max-w-2xl max-h-[80vh] rounded-3xl shadow-2xl overflow-hidden flex flex-col">
                <div
                    class="p-6 border-b border-slate-100 dark:border-slate-800 flex items-center justify-between bg-slate-50 dark:bg-slate-900">
                    <div class="flex items-center gap-3">
                        <span class="material-symbols-rounded text-primary">history</span>
                        <h2 class="font-display text-lg font-bold">Analysis History</h2>
                    </div>
                    <button onclick="toggleHistory()" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-xl">
                        <span class="material-symbols-rounded">close</span>
                    </button>
                </div>
                <div id="historyList" class="p-6 overflow-y-auto flex-1 space-y-4">
                    <p class="text-center py-10 text-xs text-slate-400">Fetching records from vault...</p>
                </div>
            </div>
        </div>

        <!-- Reminder Modal -->
        <div id="reminderModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
            <div class="absolute inset-0 bg-slate-950/40 backdrop-blur-sm" onclick="closeReminderModal()"></div>
            <div
                class="relative glass-card animate-modal w-full max-w-md rounded-3xl shadow-2xl overflow-hidden border border-slate-200/60 dark:border-slate-700/40">
                <div
                    class="p-6 border-b border-slate-100 dark:border-slate-800 flex items-center justify-between bg-gradient-to-r from-primary/5 to-purple-500/5 dark:from-primary/10 dark:to-purple-500/10">
                    <div class="flex items-center gap-3">
                        <span class="material-symbols-rounded text-primary text-2xl">notifications_active</span>
                        <div>
                            <h3 class="text-sm font-bold text-slate-900 dark:text-white">Medicine Reminder</h3>
                            <p class="text-[10px] text-slate-500 dark:text-slate-400" id="reminderMedicineName">
                                Loading...
                            </p>
                        </div>
                    </div>
                    <button onclick="closeReminderModal()"
                        class="w-8 h-8 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 flex items-center justify-center transition-colors">
                        <span class="material-symbols-rounded text-sm">close</span>
                    </button>
                </div>

                <div class="p-6 space-y-4">
                    <!-- Reminder Details -->
                    <div class="bg-slate-50 dark:bg-slate-800/50 rounded-2xl p-4 space-y-2">
                        <div class="flex justify-between text-xs">
                            <span class="text-slate-500 dark:text-slate-400">Dosage:</span>
                            <span class="font-semibold text-slate-900 dark:text-white" id="reminderDosage">-</span>
                        </div>
                        <div class="flex justify-between text-xs">
                            <span class="text-slate-500 dark:text-slate-400">Frequency:</span>
                            <span class="font-semibold text-slate-900 dark:text-white" id="reminderFrequency">-</span>
                        </div>
                        <div class="flex justify-between text-xs">
                            <span class="text-slate-500 dark:text-slate-400">Duration:</span>
                            <span class="font-semibold text-slate-900 dark:text-white" id="reminderDuration">-</span>
                        </div>
                    </div>

                    <!-- Suggested Times Auto-Fill -->
                    <div class="space-y-2">
                        <div class="flex items-center justify-between">
                            <p
                                class="text-[11px] font-semibold text-slate-700 dark:text-slate-300 uppercase tracking-wide">
                                Suggested Times:
                            </p>
                            <span class="text-[9px] text-slate-400 italic">Edit if needed</span>
                        </div>
                        <div id="reminderTimeInputs" class="flex flex-wrap gap-2">
                            <!-- Dynamic Time Inputs Injected Here -->
                        </div>
                    </div>

                    <div class="space-y-2">
                        <p class="text-[11px] font-semibold text-slate-700 dark:text-slate-300 uppercase tracking-wide">
                            Choose Reminder Method:</p>

                        <!-- Option 1: .ics File (Primary) -->
                        <button onclick="downloadICSReminder()"
                            class="w-full flex items-center gap-3 p-4 bg-gradient-to-r from-primary to-blue-600 text-white rounded-2xl hover:shadow-lg hover:shadow-primary/30 transition-all group">
                            <div
                                class="w-10 h-10 rounded-xl bg-white/20 flex items-center justify-center group-hover:scale-110 transition-transform">
                                <span class="material-symbols-rounded text-xl">download</span>
                            </div>
                            <div class="flex-1 text-left">
                                <div class="text-sm font-bold">Save to Phone Calendar</div>
                                <div class="text-[10px] opacity-90">Download .ics file (Recommended)</div>
                            </div>
                            <span class="material-symbols-rounded">chevron_right</span>
                        </button>

                        <!-- Option 2: Google Calendar -->
                        <button onclick="openGoogleCalendarReminder()"
                            class="w-full flex items-center gap-3 p-4 bg-white dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-700 rounded-2xl hover:border-primary hover:bg-primary/5 transition-all group">
                            <div
                                class="w-10 h-10 rounded-xl bg-slate-100 dark:bg-slate-700 flex items-center justify-center group-hover:scale-110 transition-transform">
                                <span class="material-symbols-rounded text-xl text-primary">event</span>
                            </div>
                            <div class="flex-1 text-left">
                                <div class="text-sm font-bold text-slate-900 dark:text-white">Add to Google Calendar
                                </div>
                                <div class="text-[10px] text-slate-500 dark:text-slate-400">Opens in new tab</div>
                            </div>
                            <span class="material-symbols-rounded text-slate-400">chevron_right</span>
                        </button>

                        <!-- Option 3: Mobile Quick Add -->
                        <button onclick="mobileQuickAdd()" id="mobileQuickAddBtn"
                            class="w-full hidden md:hidden flex items-center gap-3 p-4 bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-2xl hover:border-slate-300 transition-all">
                            <div
                                class="w-10 h-10 rounded-xl bg-slate-100 dark:bg-slate-700 flex items-center justify-center">
                                <span
                                    class="material-symbols-rounded text-xl text-slate-600 dark:text-slate-400">smartphone</span>
                            </div>
                            <div class="flex-1 text-left">
                                <div class="text-sm font-bold text-slate-700 dark:text-slate-300">Quick Mobile Add</div>
                                <div class="text-[10px] text-slate-500 dark:text-slate-400">Open calendar app</div>
                            </div>
                            <span class="material-symbols-rounded text-slate-400">chevron_right</span>
                        </button>
                    </div>

                    <p class="text-[10px] text-center text-slate-400 italic mt-4">
                         Tip: Use the first option for best results on all devices
                    </p>
                </div>
            </div>
        </div>

        <!-- Full Screen Image Preview Modal -->
        <div id="previewModal"
            class="fixed inset-0 z-50 hidden flex flex-col bg-slate-900/95 backdrop-blur-xl transition-all duration-300 opacity-0">
            <!-- Header -->
            <div class="p-4 border-b border-white/10 flex justify-between items-center bg-slate-900/50">
                <h3 class="font-display text-white font-bold tracking-wide">Review Prescription</h3>
                <div class="flex items-center gap-3">
                    <div id="blurWarningBadge"
                        class="hidden items-center gap-1.5 px-3 py-1.5 rounded-full bg-rose-500/20 border border-rose-500/30 text-rose-400 text-xs font-bold transition-all">
                        <span class="material-symbols-rounded text-sm">warning</span>
                        Image appears blurry
                    </div>
                    <div id="clearBadge"
                        class="hidden items-center gap-1.5 px-3 py-1.5 rounded-full bg-emerald-500/20 border border-emerald-500/30 text-emerald-400 text-xs font-bold transition-all">
                        <span class="material-symbols-rounded text-sm">check_circle</span>
                        Image looks clear
                    </div>
                    <button onclick="closePreviewModal()"
                        class="w-10 h-10 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center text-white transition-colors">
                        <span class="material-symbols-rounded">close</span>
                    </button>
                </div>
            </div>

            <!-- Image Container -->
            <div class="flex-1 overflow-hidden relative p-4 flex items-center justify-center">
                <img id="previewModalImg" src=""
                    class="max-w-full max-h-full object-contain rounded-2xl shadow-2xl animate-fade-in"
                    crossorigin="anonymous" />
                <canvas id="cropCanvas" class="hidden"></canvas>

                <div id="blurCheckingLoader"
                    class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm flex flex-col items-center justify-center gap-3 hidden z-10 transition-opacity rounded-2xl">
                    <span class="material-symbols-rounded text-3xl text-white spin">document_scanner</span>
                    <p class="text-xs font-bold text-white tracking-widest uppercase" id="analyzingText">Analyzing
                        Document...</p>
                </div>
            </div>

            <!-- Action Buttons Footer -->
            <div class="p-6 bg-slate-900/80 border-t border-white/10 flex flex-col sm:flex-row gap-4 justify-center">
                <button id="retakeBtn" onclick="retakePhoto()"
                    class="w-full sm:w-auto px-8 py-4 rounded-2xl border-2 border-rose-500 text-rose-500 font-bold hover:bg-rose-500/10 active:scale-95 transition-all flex items-center justify-center gap-2">
                    <span class="material-symbols-rounded">refresh</span>
                    Retake Photo
                </button>
                <button id="submitBtn" onclick="submitPreviewPhoto()" disabled
                    class="w-full sm:w-auto px-8 py-4 rounded-2xl bg-gradient-to-r from-primary to-secondary text-white font-bold shadow-lg opacity-50 cursor-not-allowed transition-all flex items-center justify-center gap-2 disabled:from-slate-600 disabled:to-slate-700 disabled:shadow-none">
                    <span class="material-symbols-rounded">check_circle</span>
                    Use This Photo
                </button>
            </div>
        </div>

        <!-- Cold-Start Banner -->
        <div id="coldStartBanner"
            class="hidden fixed bottom-6 left-1/2 -translate-x-1/2 z-[9998] flex items-center gap-3 px-5 py-3 rounded-2xl bg-slate-900/90 dark:bg-slate-800/90 backdrop-blur-md border border-slate-700/50 shadow-2xl text-white text-xs font-semibold animate-fade-in">
            <span class="w-4 h-4 rounded-full border-2 border-white border-t-transparent animate-spin shrink-0"></span>
            <span>Waking up server, please wait&hellip;</span>
        </div>

        <!-- Full Screen Processing Overlay Modal -->
        <div id="loader"
            class="fixed inset-0 z-[9999] hidden flex items-center justify-center transition-opacity duration-500 opacity-0">
            <!-- Dark semi-transparent background -->
            <div class="absolute inset-0 bg-slate-950/70 backdrop-blur-sm"></div>

            <!-- Centered glass card -->
            <div
                class="relative glass-card w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden flex flex-col p-8 text-center border border-slate-200/40 dark:border-slate-700/40 transform transition-all animate-modal">

                <!-- Animated AI Icon at top -->
                <div id="loaderIconContainer" class="relative w-20 h-20 mx-auto flex items-center justify-center mb-6">
                    <!-- Outer glowing rings -->
                    <div class="absolute inset-0 border-4 border-slate-200 dark:border-slate-700 rounded-full"></div>
                    <div
                        class="absolute inset-0 border-4 border-primary rounded-full border-t-transparent animate-spin">
                    </div>
                    <!-- Inner pulse icon -->
                    <div class="w-12 h-12 bg-primary/10 rounded-full flex items-center justify-center animate-pulse">
                        <span class="material-symbols-rounded text-primary text-3xl">auto_awesome</span>
                    </div>
                </div>

                <!-- Dynamic step messages text area -->
                <div class="w-full mb-6 text-left flex flex-col justify-center" id="loaderStepsContainer">
                    <!-- Staged progress will be injected here -->
                </div>

                <!-- Progress bar -->
                <div class="w-full h-2 bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden shadow-inner">
                    <div id="loaderProgressBar"
                        class="h-full bg-gradient-to-r from-emerald-400 to-primary rounded-full transition-all duration-700 ease-out shadow-[0_0_10px_currentColor] text-primary"
                        style="width: 0%"></div>
                </div>
            </div>
        </div>

        <script>
            // STEP 1: Auto-redirect 0.0.0.0 to localhost for secure context
            if (window.location.hostname === "0.0.0.0") {
                const newUrl = window.location.href.replace("0.0.0.0", "localhost");
                window.location.replace(newUrl);
            }

            const fileInput = document.getElementById('hiddenFileInput');
            const dashboardImg = document.getElementById('dashboardImg');
            const loader = document.getElementById('loader');
            const resultsContainer = document.getElementById('resultsContainer');
            const apiUrl = document.getElementById('apiUrl').value;
            let currentAnalyticData = null;
            let coords = null;

            //  Cold-start UX helpers 
            let coldStartTimer = null;

            function showColdStartBanner() {
                const banner = document.getElementById('coldStartBanner');
                if (banner) { banner.classList.remove('hidden'); }
            }

            function hideColdStartBanner() {
                clearTimeout(coldStartTimer);
                const banner = document.getElementById('coldStartBanner');
                if (banner) { banner.classList.add('hidden'); }
            }

            /**
             * fetchWithRetry  wraps fetch with:
             *   A per-attempt timeout (default 25 s)
             *   Up to `retries` retry attempts on failure
             *   Shows the "Waking up server" banner after 3 s on the first attempt
             */
            async function fetchWithRetry(url, options = {}, retries = 3, timeoutMs = 25000) {
                // Show cold-start banner if server takes > 3 s
                coldStartTimer = setTimeout(showColdStartBanner, 3000);
                try {
                    for (let attempt = 1; attempt <= retries; attempt++) {
                        const controller = new AbortController();
                        const tid = setTimeout(() => controller.abort(), timeoutMs);
                        try {
                            const res = await fetch(url, { ...options, signal: controller.signal });
                            clearTimeout(tid);
                            return res; // success
                        } catch (err) {
                            clearTimeout(tid);
                            if (attempt === retries) throw err;
                            // Brief back-off before retry
                            await new Promise(r => setTimeout(r, 1500 * attempt));
                        }
                    }
                } finally {
                    hideColdStartBanner();
                }
            }

            function toggleSidebar(side, forceOpen = null) {
                // Only handle left sidebar now since right is a floating widget
                if (side !== 'left') return;

                const el = document.getElementById(side + 'Sidebar');
                if (!el) return;

                const overlay = document.getElementById('drawerOverlay');

                if (forceOpen === true) {
                    el.classList.add('open');
                } else if (forceOpen === false) {
                    el.classList.remove('open');
                } else {
                    el.classList.toggle('open');
                }

                if (el.classList.contains('open')) {
                    overlay.classList.remove('hidden');
                    setTimeout(() => overlay.classList.add('opacity-100'), 10);
                } else {
                    closeAllDrawers();
                }
            }

            let isChatOpen = false;
            let unreadChatCount = 0;

            // Initialize Chat State from LocalStorage
            document.addEventListener('DOMContentLoaded', () => {
                const savedState = localStorage.getItem('mediGridChatState');
                if (savedState === 'open') {
                    setTimeout(() => toggleChatWidget(true), 100);
                }
            });

            // 10-second idle pulse animation
            setInterval(() => {
                if (!isChatOpen) {
                    const fab = document.getElementById('chatFabBtn');
                    if (fab && !fab.matches(':hover')) {
                        fab.classList.add('-translate-y-2', 'shadow-primary/60');
                        setTimeout(() => fab.classList.remove('-translate-y-2', 'shadow-primary/60'), 400);
                        setTimeout(() => fab.classList.add('-translate-y-1', 'shadow-primary/50'), 600);
                        setTimeout(() => fab.classList.remove('-translate-y-1', 'shadow-primary/50'), 800);
                    }
                }
            }, 10000);

            // Click outside to close (desktop)
            document.addEventListener('click', (e) => {
                if (isChatOpen && window.innerWidth >= 768) {
                    const widget = document.getElementById('chatWidget');
                    const fab = document.getElementById('chatFabBtn');
                    if (widget && fab && !widget.contains(e.target) && !fab.contains(e.target)) {
                        toggleChatWidget();
                    }
                }
            });

            function toggleChatWidget(forceOpen = null) {
                if (forceOpen === true && isChatOpen) return;
                isChatOpen = forceOpen !== null ? forceOpen : !isChatOpen;

                localStorage.setItem('mediGridChatState', isChatOpen ? 'open' : 'closed');

                const widget = document.getElementById('chatWidget');
                const icon = document.getElementById('chatFabIcon');
                const overlay = document.getElementById('chatOverlay');
                const badge = document.getElementById('chatUnreadBadge');
                const tooltip = document.getElementById('chatTooltip');
                const chatBox = document.getElementById('chatBox');

                if (isChatOpen) {
                    // Open
                    widget.classList.remove('pointer-events-none', 'translate-y-[100%]', 'opacity-0');
                    widget.classList.add('translate-y-0', 'opacity-100');

                    if (tooltip) tooltip.classList.add('hidden');

                    if (overlay) {
                        overlay.classList.remove('hidden');
                        // Trigger reflow
                        void overlay.offsetWidth;
                        overlay.classList.remove('opacity-0', 'pointer-events-none');
                        overlay.classList.add('opacity-100', 'pointer-events-auto');
                    }

                    icon.style.transform = 'rotate(-90deg) scale(0.5)';
                    setTimeout(() => {
                        icon.textContent = 'close';
                        icon.style.transform = 'rotate(0deg) scale(1)';
                    }, 150);

                    // Auto-scroll to latest
                    if (chatBox) chatBox.scrollTop = chatBox.scrollHeight;

                    // Clear unread badge
                    unreadChatCount = 0;
                    if (badge) {
                        badge.classList.remove('scale-100');
                        badge.classList.add('scale-0');
                        setTimeout(() => badge.classList.add('hidden'), 300);
                    }
                } else {
                    // Close
                    widget.classList.add('pointer-events-none', 'translate-y-[100%]', 'opacity-0');
                    widget.classList.remove('translate-y-0', 'opacity-100');

                    if (tooltip) tooltip.classList.remove('hidden');

                    if (overlay) {
                        overlay.classList.remove('opacity-100', 'pointer-events-auto');
                        overlay.classList.add('opacity-0', 'pointer-events-none');
                        setTimeout(() => overlay.classList.add('hidden'), 300);
                    }

                    icon.style.transform = 'rotate(90deg) scale(0.5)';
                    setTimeout(() => {
                        icon.textContent = 'chat';
                        icon.style.transform = 'rotate(0deg) scale(1)';
                    }, 150);
                }
            }

            function closeAllDrawers() {
                const overlay = document.getElementById('drawerOverlay');
                document.querySelectorAll('.sidebar-drawer').forEach(d => d.classList.remove('open'));
                overlay.classList.remove('opacity-100');
                setTimeout(() => overlay.classList.add('hidden'), 300);
            }

            function triggerUpload() { fileInput.click(); }

            function triggerScan() {
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

                if (isMobile) {
                    showToast("Opening camera...");
                    document.getElementById('cameraInput').click();
                } else {
                    showToast("Opening file browser...");
                    document.getElementById('desktopScanInput').click();
                }
            }

            let pendingFileToUpload = null;
            let processedImageBlob = null;
            let documentEdges = null;
            let currentBlurScore = 0;

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                showToast("Analyzing document...");

                // Store the file and show preview modal
                pendingFileToUpload = file;
                processedImageBlob = null;
                documentEdges = null;

                const previewModal = document.getElementById('previewModal');
                const previewImg = document.getElementById('previewModalImg');

                // Reset UI states
                document.getElementById('blurWarningBadge').style.display = 'none';
                document.getElementById('clearBadge').style.display = 'none';
                document.getElementById('submitBtn').disabled = true;
                document.getElementById('submitBtn').classList.add('opacity-50', 'cursor-not-allowed');
                document.getElementById('submitBtn').classList.remove('shadow-primary/30', 'hover:shadow-primary/50', 'active:scale-95');
                document.getElementById('retakeBtn').classList.remove('ring-4', 'ring-rose-500/50', 'bg-rose-500/10');

                const loader = document.getElementById('blurCheckingLoader');
                document.getElementById('analyzingText').textContent = "Scanning Document...";
                loader.classList.remove('hidden');

                // Clear previous image to prevent flash of old image on new selection
                previewImg.onload = null;
                previewImg.src = '';

                // Better to use URL.createObjectURL for instant preview without base64 delay
                previewImg.onload = function () {
                    // Start document analysis chain
                    setTimeout(() => processDocument(previewImg, file.type), 50);
                };
                previewImg.src = URL.createObjectURL(file);

                previewModal.classList.remove('hidden');
                // Trigger reflow for animation
                void previewModal.offsetWidth;
                previewModal.classList.remove('opacity-0');
                previewModal.classList.add('opacity-100');
            };

            function processDocument(imgElement, fileType) {
                // STEP 1: Basic Blur Detection
                const isClear = checkImageBlur(imgElement);

                if (!isClear) {
                    document.getElementById('blurCheckingLoader').classList.add('hidden');
                    return; // Stop processing if too blurry
                }

                // STEP 2: Edge Detection & Auto Crop
                document.getElementById('analyzingText').textContent = "Auto Cropping...";

                setTimeout(() => {
                    enhanceAndCropDocument(imgElement, fileType);
                }, 50);
            }

            function checkImageBlur(imgElement) {
                // Keep detection lightweight by scaling down for analysis
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d', { willReadFrequently: true });

                // Limit analysis size to 300px max dimension for speed
                const maxSize = 300;
                let width = imgElement.naturalWidth;
                let height = imgElement.naturalHeight;

                if (width > height) {
                    if (width > maxSize) {
                        height = Math.round((height * maxSize) / width);
                        width = maxSize;
                    }
                } else {
                    if (height > maxSize) {
                        width = Math.round((width * maxSize) / height);
                        height = maxSize;
                    }
                }

                canvas.width = width;
                canvas.height = height;

                // Draw image to canvas
                ctx.drawImage(imgElement, 0, 0, width, height);

                // Get pixel data
                const imageData = ctx.getImageData(0, 0, width, height);
                const data = imageData.data;

                // Convert to grayscale
                const grayData = new Float32Array(width * height);
                for (let i = 0; i < data.length; i += 4) {
                    // Weighted grayscale conversion
                    grayData[i / 4] = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
                }

                // Calculate Laplacian variance
                // Laplacian kernel: [0, 1, 0, 1, -4, 1, 0, 1, 0]
                let sum = 0;
                let count = 0;
                const laplacianValues = [];

                for (let y = 1; y < height - 1; y++) {
                    for (let x = 1; x < width - 1; x++) {
                        const idx = y * width + x;

                        const p1 = grayData[idx - width]; // top
                        const p2 = grayData[idx - 1];     // left
                        const p3 = grayData[idx];         // center
                        const p4 = grayData[idx + 1];     // right
                        const p5 = grayData[idx + width]; // bottom

                        const laplacian = p1 + p2 + p4 + p5 - (4 * p3);
                        laplacianValues.push(laplacian);
                        sum += laplacian;
                        count++;
                    }
                }

                const mean = sum / count;
                let variance = 0;

                for (let i = 0; i < laplacianValues.length; i++) {
                    variance += Math.pow(laplacianValues[i] - mean, 2);
                }
                variance = variance / count;
                currentBlurScore = variance;

                console.log("Image Blur Score (Laplacian Variance):", variance);

                // Threshold for blurriness
                const BLUR_THRESHOLD = 150;

                const submitBtn = document.getElementById('submitBtn');
                const retakeBtn = document.getElementById('retakeBtn');
                const blurBadge = document.getElementById('blurWarningBadge');

                if (variance < BLUR_THRESHOLD) {
                    blurBadge.style.display = 'flex';
                    submitBtn.disabled = true;
                    submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    retakeBtn.classList.add('ring-4', 'ring-rose-500/50', 'bg-rose-500/10');
                    return false;
                }
                return true;
            }

            function enhanceAndCropDocument(imgElement, fileType) {
                const canvas = document.getElementById('cropCanvas');
                const ctx = canvas.getContext('2d');

                // Limit max resolution for processing
                const MAX_DIM = 1600;
                let width = imgElement.naturalWidth;
                let height = imgElement.naturalHeight;

                if (width > MAX_DIM || height > MAX_DIM) {
                    const ratio = Math.min(MAX_DIM / width, MAX_DIM / height);
                    width = Math.round(width * ratio);
                    height = Math.round(height * ratio);
                }

                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(imgElement, 0, 0, width, height);

                // 1. Basic Content Bounding Box (Fast Edge Detection Approximation)
                const imgData = ctx.getImageData(0, 0, width, height);
                const data = imgData.data;

                let minX = width, minY = height, maxX = 0, maxY = 0;

                // Edge detection sampling (check every 4th pixel for speed)
                const threshold = 40; // Difference threshold
                const bgSample = (data[0] + data[1] + data[2]) / 3; // Top-left pixel as bg approx

                for (let y = 0; y < height; y += 4) {
                    for (let x = 0; x < width; x += 4) {
                        const i = (y * width + x) * 4;
                        const brightness = (data[i] + data[i + 1] + data[i + 2]) / 3;

                        if (Math.abs(brightness - bgSample) > threshold) {
                            if (x < minX) minX = x;
                            if (y < minY) minY = y;
                            if (x > maxX) maxX = x;
                            if (y > maxY) maxY = y;
                        }
                    }
                }

                // Add padding (10%) and constrain to image bounds
                const padX = Math.floor(width * 0.1);
                const padY = Math.floor(height * 0.1);
                minX = Math.max(0, minX - padX);
                minY = Math.max(0, minY - padY);
                maxX = Math.min(width, maxX + padX);
                maxY = Math.min(height, maxY + padY);

                // If bounding box is too small, fallback to full image
                const cropW = maxX - minX;
                const cropH = maxY - minY;
                const useCrop = (cropW > width * 0.3 && cropH > height * 0.3) && (cropW < width || cropH < height);

                const finalX = useCrop ? minX : 0;
                const finalY = useCrop ? minY : 0;
                const finalW = useCrop ? cropW : width;
                const finalH = useCrop ? cropH : height;

                // 2. Crop
                const croppedCanvas = document.createElement('canvas');
                croppedCanvas.width = finalW;
                croppedCanvas.height = finalH;
                const croppedCtx = croppedCanvas.getContext('2d');

                croppedCtx.drawImage(canvas, finalX, finalY, finalW, finalH, 0, 0, finalW, finalH);

                // Auto correction (contrast) has been removed from preview as requested

                // Save processed image
                const mimeType = fileType || 'image/jpeg';
                croppedCanvas.toBlob((blob) => {
                    processedImageBlob = blob;

                    // Update preview with enhanced image
                    const processedUrl = URL.createObjectURL(blob);
                    document.getElementById('previewModalImg').src = processedUrl;

                    // Complete UI transition
                    document.getElementById('blurCheckingLoader').classList.add('hidden');
                    document.getElementById('clearBadge').style.display = 'flex';

                    const submitBtn = document.getElementById('submitBtn');
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('opacity-50', 'cursor-not-allowed', 'disabled:from-slate-600', 'disabled:to-slate-700');
                    submitBtn.classList.add('shadow-primary/30', 'hover:shadow-primary/50', 'active:scale-95');
                    document.getElementById('retakeBtn').classList.remove('ring-4', 'ring-rose-500/50', 'bg-rose-500/10');

                }, mimeType, 0.9);
            }

            function closePreviewModal() {
                const previewModal = document.getElementById('previewModal');
                previewModal.classList.remove('opacity-100');
                previewModal.classList.add('opacity-0');
                setTimeout(() => {
                    previewModal.classList.add('hidden');
                    pendingFileToUpload = null;
                }, 300);
            }

            function retakePhoto() {
                closePreviewModal();
                // Clear inputs so the same file selection triggers change event again
                fileInput.value = '';
                document.getElementById('cameraInput').value = '';
                document.getElementById('desktopScanInput').value = '';
                // Trigger scan flow again
                setTimeout(() => triggerScan(), 300);
            }

            async function enhanceImage(file) {
                return new Promise((resolve) => {
                    const img = new Image();
                    const url = URL.createObjectURL(file);

                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');

                        // Maintain original dimensions
                        canvas.width = img.width;
                        canvas.height = img.height;

                        // Draw image
                        ctx.drawImage(img, 0, 0);

                        // Get raw pixel data
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        const data = imageData.data;

                        // Enhancement settings
                        const contrast = 1.25; // Increase contrast
                        const brightness = 15; // Slight brightness bump

                        const intercept = 128 * (1 - contrast);

                        for (let i = 0; i < data.length; i += 4) {
                            // Apply contrast and brightness to RGB channels
                            data[i] = data[i] * contrast + intercept + brightness;     // R
                            data[i + 1] = data[i + 1] * contrast + intercept + brightness; // G
                            data[i + 2] = data[i + 2] * contrast + intercept + brightness; // B
                        }

                        ctx.putImageData(imageData, 0, 0);

                        // Convert back to higher clarity JPEG blob
                        canvas.toBlob((blob) => {
                            URL.revokeObjectURL(url);
                            resolve(blob);
                        }, 'image/jpeg', 0.95);
                    };

                    img.src = url;
                });
            }

            let loaderIsRunning = false;
            let isForceCompleting = false;
            let activeStepsCount = 0;

            function showProcessingModal() {
                const loader = document.getElementById('loader');
                loader.classList.remove('hidden', 'opacity-0');
                loader.classList.add('opacity-100');

                // Restore default icon
                const iconContainer = document.getElementById('loaderIconContainer');
                if (iconContainer) {
                    iconContainer.innerHTML = `
                    <div class="absolute inset-0 border-4 border-slate-200 dark:border-slate-700 rounded-full"></div>
                    <div class="absolute inset-0 border-4 border-primary rounded-full border-t-transparent animate-spin"></div>
                    <div class="w-12 h-12 bg-primary/10 rounded-full flex items-center justify-center animate-pulse">
                        <span class="material-symbols-rounded text-primary text-3xl">auto_awesome</span>
                    </div>
                `;
                }

                const titleEl = document.getElementById('loaderStageTitle');
                if (titleEl) {
                    titleEl.classList.remove('text-emerald-500');
                    titleEl.classList.add('text-slate-800', 'dark:text-white');
                }

                startLoaderAnimation();
            }

            async function hideProcessingModal(isSuccess = true) {
                const loader = document.getElementById('loader');

                if (loaderIsRunning) {
                    isForceCompleting = true;
                    // Give it a brief moment to complete the fast-forward visually
                    await new Promise(r => setTimeout(r, 600));
                }

                if (isSuccess) {
                    const titleEl = document.getElementById('loaderStageTitle');
                    if (titleEl) {
                        titleEl.textContent = "Analysis Complete";
                        titleEl.classList.remove('text-slate-800', 'dark:text-white');
                        titleEl.classList.add('text-emerald-500');
                    }

                    const iconContainer = document.getElementById('loaderIconContainer');
                    if (iconContainer) {
                        iconContainer.innerHTML = `
                        <div class="absolute inset-0 border-4 border-emerald-500/30 rounded-full scale-110 animate-ping"></div>
                        <div class="w-16 h-16 bg-emerald-500 rounded-full flex items-center justify-center shadow-lg shadow-emerald-500/40">
                            <span class="material-symbols-rounded text-white text-4xl font-bold">check</span>
                        </div>
                    `;
                    }

                    // Wait 500ms showing final state
                    await new Promise(r => setTimeout(r, 500));
                }

                // Fade out smoothly
                loader.classList.remove('opacity-100');
                loader.classList.add('opacity-0');
                await new Promise(r => setTimeout(r, 500));

                loaderIsRunning = false;
                isForceCompleting = false;
                loader.classList.add('hidden');
            }

            async function startLoaderAnimation() {
                loaderIsRunning = true;
                isForceCompleting = false;
                const stages = [
                    "Analyzing prescription image...",
                    "Extracting patient details...",
                    "Reading medicine names...",
                    "Checking drug interactions...",
                    "Finding nearby pharmacies..."
                ];

                activeStepsCount = stages.length;
                const container = document.getElementById('loaderStepsContainer');
                const barEl = document.getElementById('loaderProgressBar');
                const loader = document.getElementById('loader');

                container.innerHTML = stages.map((stage, idx) => `
                <div id="loader-step-${idx}" class="flex items-center gap-3 mb-2 opacity-30 transition-all duration-300 transform translate-y-1">
                    <div class="w-5 h-5 rounded-full border-2 border-slate-300 dark:border-slate-600 flex items-center justify-center shrink-0 transition-colors" id="loader-icon-${idx}">
                    </div>
                    <span class="text-xs font-medium text-slate-600 dark:text-slate-400 transition-colors" id="loader-text-${idx}">${stage}</span>
                </div>
            `).join('');

                barEl.style.width = '0%';
                loader.classList.remove('hidden');

                for (let i = 0; i < stages.length; i++) {
                    if (!loaderIsRunning && !isForceCompleting) break;

                    const stepEl = document.getElementById(`loader-step-${i}`);
                    const iconEl = document.getElementById(`loader-icon-${i}`);
                    const textEl = document.getElementById(`loader-text-${i}`);

                    if (!stepEl) continue;

                    // Active State (Skip if force completing to just show checkmarks quickly)
                    if (!isForceCompleting) {
                        stepEl.classList.remove('opacity-30', 'translate-y-1');
                        stepEl.classList.add('opacity-100');
                        iconEl.classList.remove('border-slate-300', 'dark:border-slate-600');
                        iconEl.classList.add('border-primary');
                        iconEl.innerHTML = `<div class="w-2 h-2 rounded-full bg-primary animate-pulse"></div>`;
                        textEl.classList.remove('text-slate-600', 'dark:text-slate-400');
                        textEl.classList.add('text-primary', 'font-bold');

                        // Wait 700 - 900ms
                        const delay = Math.floor(Math.random() * 200) + 700;
                        await new Promise(r => setTimeout(r, delay));
                    }

                    if (!loaderIsRunning && !isForceCompleting) break;

                    // Completed state
                    stepEl.classList.remove('opacity-30', 'translate-y-1');
                    stepEl.classList.add('opacity-100');
                    iconEl.classList.remove('border-primary', 'border-slate-300', 'dark:border-slate-600');
                    iconEl.classList.add('bg-emerald-500', 'border-emerald-500');
                    iconEl.innerHTML = `<span class="material-symbols-rounded text-white text-[12px] font-bold">check</span>`;
                    textEl.classList.remove('text-primary');
                    textEl.classList.add('text-slate-800', 'dark:text-white', 'font-bold');

                    // Animate progress bar width
                    barEl.style.width = `${((i + 1) / stages.length) * 100}%`;

                    if (isForceCompleting) {
                        await new Promise(r => setTimeout(r, 100)); // Fast completion tick
                    }
                }
            }

            async function submitPreviewPhoto() {
                if (!pendingFileToUpload) return;
                const file = pendingFileToUpload;

                // Keep original for UI preview if standard file upload without crop
                const originalBlob = processedImageBlob || file;

                closePreviewModal();

                resultsContainer.scrollIntoView({ behavior: 'smooth' });
                dashboardImg.src = URL.createObjectURL(originalBlob);

                showProcessingModal();

                // Process the image for the backend solely to improve OCR
                const enhancedBlob = await enhanceImage(originalBlob);
                showToast("Document enhanced & ready");

                const formData = new FormData();
                formData.append('image', enhancedBlob, file.name || 'scanned_prescription.jpg');
                if (coords) formData.append('user_location', JSON.stringify(coords));

                try {
                    const res = await fetchWithRetry(apiUrl, { method: 'POST', body: formData });
                    const data = await res.json();
                    const response = data;

                    // Treat empty or invalid schemas as extraction failures
                    if (data.error || (!data.Prescription_info && !data.medicines && !data.medications && Object.keys(data).length < 2)) {
                        throw new Error(data.error || "Failed to extract medical data.");
                    }

                    if (response.success === true || data.success === undefined) {
                        document.getElementById("resultsContainer").style.display = "block";
                        document.getElementById("resultsContainer").classList.remove("hidden");
                        document.getElementById("actionButtons").style.display = "flex";
                    }

                    currentAnalyticData = data;
                    renderMainData(data);
                    fetchWarnings(data);
                    await hideProcessingModal(true);
                    showToast("Analysis complete. Check medication markers.");
                } catch (err) {
                    await hideProcessingModal(false);

                    const list = document.querySelector('.med-list');
                    const isBlurry = currentBlurScore < 300; // Threshold for suspicious clarity if extraction failed
                    const errorMsg = isBlurry
                        ? "Low clarity detected. Please retake photo in good lighting."
                        : "AI service temporarily unavailable. Please try again.";

                    list.innerHTML = `
                    <div id="errorCard" class="bg-rose-50/80 dark:bg-rose-900/10 border border-rose-200 dark:border-rose-800/50 rounded-3xl p-6 shadow-xl shadow-rose-500/10 animate-fade-in relative overflow-hidden group">
                        <div class="absolute -right-10 -top-10 w-32 h-32 bg-rose-500/10 rounded-full blur-2xl group-hover:bg-rose-500/20 transition-colors duration-500"></div>
                        <div class="flex items-start gap-4 relative">
                            <div class="w-12 h-12 rounded-2xl bg-rose-100 dark:bg-rose-900/30 flex items-center justify-center shrink-0 border border-rose-200 dark:border-rose-800/50 shadow-inner">
                                <span class="material-symbols-rounded text-rose-500 text-2xl animate-pulse">error</span>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-display text-lg font-bold text-slate-900 dark:text-white mb-1">Extraction Failed</h3>
                                <p class="text-xs text-rose-600 dark:text-rose-400 font-medium leading-relaxed mb-4">${errorMsg}</p>
                                <button onclick="retakePhoto()" class="px-5 py-2.5 bg-rose-500 hover:bg-rose-600 active:bg-rose-700 text-white text-xs font-bold rounded-xl shadow-lg shadow-rose-500/30 hover:shadow-rose-500/50 transition-all flex items-center gap-2">
                                    <span class="material-symbols-rounded text-sm">replay</span>
                                    Try Again
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                    document.getElementById('patientData').innerHTML = '';
                    toggleTab('data');

                    setTimeout(() => {
                        const card = document.getElementById('errorCard');
                        if (card) card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 100);
                }
            }

            fileInput.addEventListener('change', handleFileUpload);
            document.getElementById('cameraInput').addEventListener('change', handleFileUpload);
            document.getElementById('desktopScanInput').addEventListener('change', handleFileUpload);

            function renderMainData(data) {
                // Error handling is now managed entirely in submitPreviewPhoto catch block
                const p = data.patient_info || {};
                document.getElementById('patientData').innerHTML = `
                <span>ID: ${p.patient_name || 'N/A'}</span>
                <span>AGE: ${p.age || 'N/A'}</span>
                <span>DATE: ${p.Date || 'N/A'}</span>
            `;

                const list = document.querySelector('.med-list');

                // Inject animated success banner
                list.innerHTML = `
                <div id="successBanner" class="bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-200 dark:border-emerald-800/50 rounded-2xl p-4 flex items-center justify-center gap-3 shadow-lg shadow-emerald-500/10 pointer-events-none relative overflow-hidden transition-all duration-500 opacity-0 -translate-y-4 origin-top">
                    <div class="w-8 h-8 rounded-full bg-emerald-100 dark:bg-emerald-900/40 flex items-center justify-center shrink-0">
                        <span class="material-symbols-rounded text-emerald-500 font-bold text-xl">check_circle</span>
                    </div>
                    <span class="font-bold text-emerald-700 dark:text-emerald-400 text-sm tracking-wide">Analysis Completed Successfully</span>
                </div>
            `;

                // Trigger entrance animation
                setTimeout(() => {
                    const banner = document.getElementById('successBanner');
                    if (banner) banner.classList.remove('opacity-0', '-translate-y-4');
                }, 50);

                // Auto-dismiss after 3 seconds
                setTimeout(() => {
                    const banner = document.getElementById('successBanner');
                    if (banner) {
                        banner.classList.add('opacity-0', '-translate-y-4');
                        setTimeout(() => banner.remove(), 500); // Wait for transition to finish before removing DOM element
                    }
                }, 3000);

                // STEP 1: Robust schema detection
                let meds = [];

                if (Array.isArray(data.Prescription_info)) {
                    meds = data.Prescription_info;
                }
                else if (Array.isArray(data.medicines)) {
                    meds = data.medicines;
                }
                else if (Array.isArray(data.medications)) {
                    meds = data.medications;
                }
                else if (data.Prescription_info && typeof data.Prescription_info === "object") {
                    meds = Object.values(data.Prescription_info);
                }
                else {
                    for (const key in data) {
                        if (Array.isArray(data[key])) {
                            meds = data[key];
                            break;
                        }
                    }
                }

                console.log("Detected medicines:", meds);

                // STEP 3: Show debug if no medicines found
                if (meds.length === 0) {
                    list.innerHTML = `
                    <pre style="font-size:10px;white-space:pre-wrap;">
${JSON.stringify(data, null, 2)}
                    </pre>
                `;
                    return;
                }

                // Generate Summary Metrics
                let warningCount = 0;
                // Attempt to glean warnings from various possible schema locations
                if (Array.isArray(data.Warnings)) warningCount = data.Warnings.length;
                else if (Array.isArray(data.safety_warnings)) warningCount = data.safety_warnings.length;
                else if (data.Safety_Warnings && Array.isArray(data.Safety_Warnings.warnings)) warningCount = data.Safety_Warnings.warnings.length;

                let maxDurationInt = 0;
                let maxDurationStr = 'N/A';
                meds.forEach(m => {
                    const durStr = m.Duration || m.duration || '';
                    const match = durStr.match(/(\d+)/);
                    if (match) {
                        const num = parseInt(match[1]);
                        if (num > maxDurationInt) {
                            maxDurationInt = num;
                            maxDurationStr = durStr;
                        }
                    } else if (durStr && maxDurationInt === 0) {
                        maxDurationStr = durStr;
                    }
                });

                let riskLevel = 'Safe';
                let riskColor = 'text-emerald-500';
                let riskBg = 'bg-emerald-500/10';
                let riskIcon = 'check_circle';
                let meterWidth = '15%';
                let meterGradient = 'from-emerald-400 to-emerald-500';
                let meterShadowColor = 'rgba(16,185,129,0.5)';

                if (warningCount > 2) {
                    riskLevel = 'Critical';
                    riskColor = 'text-rose-500';
                    riskBg = 'bg-rose-500/10';
                    riskIcon = 'warning';
                    meterWidth = '95%';
                    meterGradient = 'from-rose-400 to-rose-500';
                    meterShadowColor = 'rgba(244,63,94,0.5)';
                } else if (warningCount > 0) {
                    riskLevel = 'Caution';
                    riskColor = 'text-amber-500';
                    riskBg = 'bg-amber-500/10';
                    riskIcon = 'error';
                    meterWidth = '50%';
                    meterGradient = 'from-amber-400 to-amber-500';
                    meterShadowColor = 'rgba(245,158,11,0.5)';
                }

                // Insert Summary Card
                list.innerHTML += `
                <div class="mb-6 p-5 rounded-3xl bg-gradient-to-br from-white to-slate-50 dark:from-slate-800 dark:to-slate-900 border border-slate-200/60 dark:border-slate-700/40 shadow-lg animate-fade-in relative overflow-hidden group">
                    <div class="absolute -right-10 -top-10 w-32 h-32 bg-primary/5 rounded-full blur-2xl group-hover:bg-primary/10 transition-colors duration-500"></div>
                    
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-8 h-8 rounded-xl bg-primary/10 flex items-center justify-center">
                            <span class="material-symbols-rounded text-primary text-sm">receipt_long</span>
                        </div>
                        <h3 class="font-display text-base font-bold text-slate-900 dark:text-white">Prescription Summary</h3>
                    </div>

                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                        <div class="p-3 rounded-2xl bg-white/60 dark:bg-slate-800/60 border border-slate-100 dark:border-slate-700">
                            <span class="block text-[10px] font-bold uppercase tracking-wider text-slate-400 mb-1">Total Meds</span>
                            <div class="flex items-center gap-2">
                                <span class="material-symbols-rounded text-slate-400 text-sm">pill</span>
                                <span class="text-lg font-black text-slate-800 dark:text-white">${meds.length}</span>
                            </div>
                        </div>

                        <div class="p-3 rounded-2xl bg-white/60 dark:bg-slate-800/60 border border-slate-100 dark:border-slate-700">
                            <span class="block text-[10px] font-bold uppercase tracking-wider text-slate-400 mb-1">Warnings</span>
                            <div class="flex items-center gap-2">
                                <span class="material-symbols-rounded text-amber-500 text-sm">notifications_active</span>
                                <span class="text-lg font-black text-slate-800 dark:text-white">${warningCount}</span>
                            </div>
                        </div>

                        <div class="p-3 rounded-2xl bg-white/60 dark:bg-slate-800/60 border border-slate-100 dark:border-slate-700">
                            <span class="block text-[10px] font-bold uppercase tracking-wider text-slate-400 mb-1">Duration</span>
                            <div class="flex items-center gap-2">
                                <span class="material-symbols-rounded text-blue-500 text-sm">calendar_month</span>
                                <span class="text-sm font-bold text-slate-800 dark:text-white truncate" title="${maxDurationStr}">${maxDurationStr}</span>
                            </div>
                        </div>

                        <div class="p-3 rounded-2xl ${riskBg} border border-transparent flex flex-col justify-center">
                            <span class="block text-[10px] font-bold uppercase tracking-wider ${riskColor} opacity-70 mb-1">Status</span>
                            <div class="flex items-center gap-2">
                                <span class="material-symbols-rounded ${riskColor} text-sm">${riskIcon}</span>
                                <span class="text-sm font-bold ${riskColor}">${riskLevel}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Medical Risk Meter -->
                    <div class="mt-4 pt-4 border-t border-slate-200/60 dark:border-slate-700/60">
                        <div class="flex justify-between items-end mb-2">
                            <span class="text-[11px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest">
                                Overall Prescription Risk Level: <span class="${riskColor} ml-1">${riskLevel}</span>
                            </span>
                        </div>
                        <div class="h-2.5 w-full bg-slate-200 dark:bg-slate-700/50 rounded-2xl overflow-hidden relative shadow-inner">
                            <div id="riskMeterBar" class="h-full rounded-2xl bg-gradient-to-r ${meterGradient} shadow-[0_0_10px_currentColor] transition-all duration-1000 ease-[cubic-bezier(0.4,0,0.2,1)] relative" style="width: 0%; color: ${meterShadowColor};">
                                <div class="absolute inset-0 bg-white/20 animate-pulse rounded-2xl"></div>
                            </div>
                        </div>
                        <div class="flex justify-between items-center mt-1.5 px-1">
                            <span class="text-[9px] text-slate-400 font-medium">SAFE</span>
                            <span class="text-[9px] text-slate-400 font-medium">CAUTION</span>
                            <span class="text-[9px] text-slate-400 font-medium">CRITICAL</span>
                        </div>
                    </div>
                </div>
            `;

                meds.forEach((m, index) => {
                    const confidence = 94 - (index * 2); // Simulate confidence scores
                    list.innerHTML += `
                    <div class="relative p-6 rounded-3xl bg-gradient-to-br from-slate-50/90 to-white/90 dark:from-slate-800/50 dark:to-slate-800/30 border border-slate-200/60 dark:border-slate-700/40 backdrop-blur-sm hover:shadow-2xl hover:-translate-y-2 transition-all duration-300 active:scale-98 animate-fade-in group overflow-hidden">
                        <!-- Accent Bar -->
                        <div class="accent-bar"></div>
                        
                        <!-- Header with Medicine Name and Confidence -->
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex-1">
                                <h4 class="font-display text-lg font-bold text-slate-900 dark:text-white tracking-tight mb-1">${m.medications || m.name || m.drug_name || m.medicine || "Unknown"}</h4>
                                <div class="confidence-bar" style="--confidence: ${confidence}%"></div>
                            </div>
                            <div class="flex flex-col items-end gap-1 relative group/tooltip cursor-help" tabindex="0">
                                <span class="text-xs font-semibold px-2 py-1 rounded-full bg-primary/10 text-primary transition-colors group-hover/tooltip:bg-primary/20">${confidence}%</span>
                                <span class="text-[9px] font-medium text-slate-400 border-b border-dashed border-slate-300 dark:border-slate-600">AI Confidence</span>
                                
                                <!-- Tooltip -->
                                <div class="absolute bottom-full right-0 mb-2 w-48 p-2 text-[10px] leading-tight text-white bg-slate-800 dark:bg-slate-100 dark:text-slate-900 rounded-lg shadow-xl opacity-0 invisible group-hover/tooltip:opacity-100 group-hover/tooltip:visible group-focus/tooltip:opacity-100 group-focus/tooltip:visible focus-within:opacity-100 focus-within:visible transition-all duration-300 transform scale-95 group-hover/tooltip:scale-100 group-focus/tooltip:scale-100 z-50 pointer-events-none before:content-[''] before:absolute before:top-full before:right-6 before:-mt-1 before:border-4 before:border-transparent before:border-t-slate-800 dark:before:border-t-slate-100 text-center">
                                    This score represents OCR and AI extraction confidence based on image clarity and structured parsing.
                                </div>
                            </div>
                        </div>

                        <!-- Medication Details Grid -->
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <div class="flex items-center gap-2 px-3 py-2 rounded-xl bg-white/60 dark:bg-slate-900/40 border border-slate-200/40 dark:border-slate-700/40">
                                <span class="material-symbols-rounded text-base text-primary">vaccines</span>
                                <div class="flex-1">
                                    <p class="text-[9px] font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wide">Dosage</p>
                                    <p class="text-xs font-bold text-slate-900 dark:text-white">${m.Dosage || m.dosage || m.dose || m.strength || "N/A"}</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2 px-3 py-2 rounded-xl bg-white/60 dark:bg-slate-900/40 border border-slate-200/40 dark:border-slate-700/40">
                                <span class="material-symbols-rounded text-base text-primary">schedule</span>
                                <div class="flex-1">
                                    <p class="text-[9px] font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wide">Frequency</p>
                                    <p class="text-xs font-bold text-slate-900 dark:text-white capitalize">${m.Frequency || m.frequency || m.schedule || m.timing || "N/A"}</p>
                                </div>
                            </div>
                        </div>

                        <!-- Duration Badge -->
                        <div class="flex items-center gap-2 mb-4">
                            <span class="material-symbols-rounded text-sm text-slate-400">calendar_today</span>
                            <span class="text-xs font-semibold px-3 py-1 rounded-full bg-emerald-500/10 text-emerald-600 dark:text-emerald-400">
                                ${m.Duration || 'As prescribed'}
                            </span>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex gap-2">
                            <a href="${m.Map_link}" target="_blank" class="flex-1 flex items-center justify-center gap-2 py-2.5 px-4 bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 text-xs font-bold text-slate-700 dark:text-slate-200 hover:bg-primary hover:text-white hover:border-primary transition-all active:scale-95 group/btn">
                                <span class="material-symbols-rounded text-sm group-hover/btn:scale-110 transition-transform">location_on</span>
                                LOCATE
                            </a>
                            <button onclick='openReminderModal(${JSON.stringify(m)})' class="flex-1 flex items-center justify-center gap-2 py-2.5 px-4 bg-gradient-to-r from-purple-500 to-primary text-white rounded-xl text-xs font-bold hover:shadow-lg hover:shadow-purple-500/30 transition-all active:scale-95 group/btn">
                                <span class="material-symbols-rounded text-sm group-hover/btn:scale-110 transition-transform">notifications_active</span>
                                REMIND
                            </button>
                        </div>
                    </div>`;
                });

                // Add AI Confidence Summary Badge after medicines
                list.innerHTML += `
                <div class="mt-8 flex flex-col items-center gap-4">
                    <div class="flex items-center gap-3 px-6 py-3 rounded-2xl bg-gradient-to-r from-emerald-500/10 to-primary/10 border border-emerald-500/20 backdrop-blur-sm">
                        <span class="material-symbols-rounded text-2xl text-emerald-600 dark:text-emerald-400">verified</span>
                        <div>
                            <p class="text-xs font-bold text-slate-900 dark:text-white">Verified Medical AI</p>
                            <p class="text-[10px] text-slate-600 dark:text-slate-400">Analysis Confidence: 94%</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 text-[10px] text-slate-500 dark:text-slate-400">
                        <span class="material-symbols-rounded text-sm">schedule</span>
                        <span>Analyzed: ${new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}</span>
                        <span class="mx-2"></span>
                        <span class="material-symbols-rounded text-sm">lock</span>
                        <span>Secure Vault</span>
                    </div>
                </div>
            `;
                toggleTab('data');

                // Initialize pharmacy map after rendering data
                initializeMap();

                // Animate Risk Meter
                setTimeout(() => {
                    const bar = document.getElementById('riskMeterBar');
                    if (bar) bar.style.width = meterWidth;
                }, 100);
            }

            async function fetchWarnings(data) {
                try {
                    const res = await fetchWithRetry("/critical_warnings", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    const warns = await res.json();
                    const list = document.querySelector('.warn-list');
                    const badge = document.getElementById('warnCount');
                    list.innerHTML = '';

                    const warnArr = Array.isArray(warns) ? warns : (warns ? [warns] : []);

                    if (warnArr.length > 0) {
                        badge.classList.remove('hidden');
                        badge.textContent = warnArr.length;
                        warnArr.forEach(w => {
                            list.innerHTML += `
                            <div class="flex gap-3 p-4 bg-rose-50 dark:bg-rose-900/10 border-l-4 border-rose-500 rounded-xl">
                                <span class="material-symbols-rounded text-rose-500 text-lg">report</span>
                                <p class="text-[11px] font-medium text-rose-700 dark:text-rose-300 leading-relaxed">${w}</p>
                            </div>`;
                        });
                    } else {
                        badge.classList.add('hidden');
                        list.innerHTML = '<p class="text-xs text-slate-400 p-8 text-center italic">No safety concerns detected.</p>';
                    }
                } catch (e) { console.error(e); }
            }

            function toggleTab(id) {
                document.getElementById('tabData').classList.add('hidden');
                document.getElementById('tabWarn').classList.add('hidden');
                document.getElementById('tabDataBtn').classList.remove('bg-primary/10', 'text-primary');
                document.getElementById('tabWarnBtn').classList.remove('bg-primary/10', 'text-primary');

                document.getElementById('tab' + id.charAt(0).toUpperCase() + id.slice(1)).classList.remove('hidden');
                document.getElementById('tab' + id.charAt(0).toUpperCase() + id.slice(1) + 'Btn').classList.add('bg-primary/10', 'text-primary');
            }

            // Location state and responsive text helper
            let locationLocked = false;

            function updateLocationText() {
                const locationTxt = document.getElementById('locationTxt');
                if (locationTxt && locationLocked) {
                    const isMobile = window.innerWidth < 640; // Tailwind sm breakpoint
                    locationTxt.textContent = isMobile ? "Area Locked" : "Current Area Locked";
                }
            }

            // Listen for window resize to update location text dynamically
            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(updateLocationText, 100); // Debounce for performance
            });

            async function requestRealLocation() {
                // STEP 5: Add console debug logs
                console.log("Secure Context:", window.isSecureContext);
                console.log("Origin:", window.location.origin);

                // STEP 2: Add secure context check
                if (!window.isSecureContext) {
                    showToast(" Location requires secure context. Please use http://localhost:8000");
                    return;
                }

                if (!navigator.geolocation) {
                    showToast("Geolocation not supported by browser.");
                    return;
                }

                // STEP 3: Improved error handling with error codes
                navigator.geolocation.getCurrentPosition(
                    p => {
                        coords = { latitude: p.coords.latitude, longitude: p.coords.longitude };
                        document.getElementById('locationBadge').classList.remove('hidden');
                        locationLocked = true; // Mark location as locked
                        updateLocationText(); // Use helper function for responsive text
                        showToast("GPS verification successful.");
                        console.log("Location acquired:", coords);
                    },
                    error => {
                        console.error("Geolocation error:", error);
                        if (error.code === 1) {
                            showToast("Location permission denied.");
                        } else if (error.code === 2) {
                            showToast("Location unavailable.");
                        } else if (error.code === 3) {
                            showToast("Location request timed out.");
                        } else {
                            showToast("Location error occurred.");
                        }
                    },
                    { enableHighAccuracy: true, timeout: 10000 }
                );
            }

            async function sendChat() {
                const inp = document.getElementById('chatInput');
                const val = inp.value.trim();
                if (!val) return;

                const box = document.getElementById('chatBox');
                box.innerHTML += `
                <div class="flex justify-end animate-fade-in">
                    <div class="bg-primary text-white p-3 rounded-2xl rounded-tr-none shadow-sm max-w-[85%]">
                        <p class="text-[11px] font-medium leading-relaxed">${val}</p>
                    </div>
                </div>`;
                inp.value = '';
                box.scrollTop = box.scrollHeight;

                try {
                    const res = await fetchWithRetry("/chat", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: val })
                    }, 2, 20000);
                    const data = await res.json();

                    box.innerHTML += `
                    <div class="flex gap-3 max-w-[90%] animate-fade-in mt-4">
                        <div class="w-8 h-8 rounded-xl bg-gradient-to-br from-primary/20 to-blue-500/20 flex items-center justify-center shrink-0 border border-primary/10">
                            <span class="material-symbols-rounded text-primary text-[14px]">smart_toy</span>
                        </div>
                        <div class="bg-white dark:bg-slate-800 p-3 rounded-2xl rounded-tl-none shadow-sm border border-slate-100 dark:border-slate-700">
                            <div class="text-[11px] font-medium opacity-80 leading-relaxed text-slate-700 dark:text-slate-200">${data.response || 'Connection lost.'}</div>
                        </div>
                    </div>`;
                    box.scrollTop = box.scrollHeight;

                    if (!isChatOpen) {
                        unreadChatCount++;
                        const badge = document.getElementById('chatUnreadBadge');
                        if (badge) {
                            badge.textContent = unreadChatCount > 9 ? '9+' : unreadChatCount;
                            badge.classList.remove('hidden');
                            void badge.offsetWidth; // Reflow
                            badge.classList.remove('scale-0');
                            badge.classList.add('scale-100');
                        }
                    }
                } catch (e) {
                    showToast("Chat engine is offline.");
                }
            }

            function startVoiceInput() {
                if (!('webkitSpeechRecognition' in window)) return showToast("Browser not supported.");
                const r = new webkitSpeechRecognition();
                r.start();
                showToast("Listening to query...");
                r.onresult = e => {
                    document.getElementById('chatInput').value = e.results[0][0].transcript;
                    sendChat();
                };
            }

            function toggleHistory() {
                const m = document.getElementById('historyModal');
                m.classList.toggle('hidden');
                if (!m.classList.contains('hidden')) loadHistory();
            }

            async function loadHistory() {
                const list = document.getElementById('historyList');
                try {
                    const res = await fetchWithRetry("/get_Saved_data", {}, 3, 15000);
                    const data = await res.json();
                    list.innerHTML = data.length ? '' : '<p class="text-center py-10 text-xs text-slate-400">No records found.</p>';
                    data.forEach(h => {
                        list.innerHTML += `
                        <div class="p-4 bg-slate-50 dark:bg-slate-800/20 rounded-2xl border border-slate-100 dark:border-slate-800">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-xs font-bold text-primary">${h.Patient || 'Generic'}</span>
                                <span class="text-[9px] font-bold text-slate-400">${h.Date || 'Vault'}</span>
                            </div>
                            <p class="text-[10px] text-slate-500 truncate">${h.Medications || ''}</p>
                        </div>`;
                    });
                } catch (e) { list.innerHTML = '<p class="text-center py-10 text-xs text-rose-400">Database connection error.</p>'; }
            }

            let activeToastTimeout = null;
            let activeToastHideTimeout = null;
            let lastToastMsg = '';

            function showToast(m) {
                // Prevent exact same message flickering within 2.5 seconds
                if (m === lastToastMsg && activeToastTimeout) {
                    return;
                }

                // Remove existing toast if any (Singleton enforcement)
                const existingToast = document.querySelector('.toast');
                if (existingToast) {
                    existingToast.remove();
                    clearTimeout(activeToastTimeout);
                    clearTimeout(activeToastHideTimeout);
                }

                lastToastMsg = m;

                // Create new toast
                const t = document.createElement('div');
                // Remove animate-fade-in to not conflict with our custom transitions
                t.className = 'toast shadow-xl shadow-slate-900/10 z-[99999]';
                t.textContent = m;
                document.body.appendChild(t);

                // Force reflow to ensure transition runs when class is added
                t.offsetHeight;
                t.classList.add('show');

                // Set primary display lifespan (2.5 seconds)
                activeToastTimeout = setTimeout(() => {
                    t.classList.remove('show');
                    t.classList.add('hide');

                    // Wait for the CSS transition (0.3s) before physically removing from DOM
                    activeToastHideTimeout = setTimeout(() => {
                        t.remove();
                        lastToastMsg = ''; // Reset after full dismissal
                        activeToastTimeout = null;
                        activeToastHideTimeout = null;
                    }, 300);
                }, 2500);
            }

            function generateMedicalReport() {
                if (!currentAnalyticData) {
                    showToast("No analysis data available to download.");
                    return;
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                const data = currentAnalyticData || window.analysisData;

                // Log exact object being parsed
                console.log("ANALYSIS OBJECT:", data);

                const p = data?.patient_info || data?.Prescription_info || {};
                const patientName = p?.patient_name || p?.Patient_Name || "Not Found";
                const patientAge = p?.age || p?.Age || "-";
                const date = p?.Date || p?.date || "-";

                // Same schema detection loop used in renderMainData
                let medicines = [];
                if (Array.isArray(data?.Prescription_info)) medicines = data.Prescription_info;
                else if (Array.isArray(data?.medicines)) medicines = data.medicines;
                else if (Array.isArray(data?.medications)) medicines = data.medications;
                else if (data?.Prescription_info && typeof data.Prescription_info === "object") meds = Object.values(data.Prescription_info);
                else if (data) {
                    for (const key in data) {
                        if (Array.isArray(data[key])) {
                            medicines = data[key];
                            break;
                        }
                    }
                }

                const warns = data?.Safety_warnings || data?.safety_warnings || (data?.Warnings ? data.Warnings : []) || [];

                if (!data || !medicines.length) {
                    alert("No analysis data available for report generation.");
                    return;
                }

                const reportId = Math.floor(100000 + Math.random() * 900000);

                // Determine Risk Level
                let riskLevel = "SAFE";
                let riskColor = [16, 185, 129]; // Green
                if (warns.length > 0 && warns.length <= 2) {
                    riskLevel = "CAUTION";
                    riskColor = [245, 158, 11]; // Orange
                } else if (warns.length > 2) {
                    riskLevel = "CRITICAL";
                    riskColor = [239, 68, 68]; // Red
                }

                let pageNum = 1;
                const pageHeight = doc.internal.pageSize.height || doc.internal.pageSize.getHeight();

                const addFooter = () => {
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'italic');
                    doc.setTextColor(150);
                    doc.text("Generated by MediGrid AI  Informational Use Only", 20, pageHeight - 10);

                    doc.text(`Page ${pageNum}`, 190, pageHeight - 10, { align: "right" });

                    // Reset styling for next texts
                    doc.setTextColor(0);
                    doc.setFont(undefined, 'normal');
                };

                // Header Section
                doc.setFontSize(22);
                doc.setFont(undefined, 'bold');
                doc.text("MediGrid AI", 20, 20);

                doc.setFontSize(14);
                doc.setFont(undefined, 'normal');
                doc.text("Prescription Analysis Report", 20, 28);

                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text(`Report ID: #${reportId}`, 190, 20, { align: "right" });
                doc.text(`Date: ${new Date().toLocaleDateString()}`, 190, 26, { align: "right" });
                doc.setTextColor(0);

                doc.setDrawColor(200);
                doc.line(20, 32, 190, 32);

                // Risk Assessment Section
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text("Risk Assessment", 20, 42);

                doc.setFontSize(12);
                doc.setTextColor(riskColor[0], riskColor[1], riskColor[2]);
                doc.text(`Level: ${riskLevel}`, 20, 50);
                doc.setTextColor(0);
                doc.setFont(undefined, 'normal');
                doc.text(`Total Warnings Detected: ${warns.length}`, 80, 50);

                doc.line(20, 58, 190, 58);

                // Patient Details Section
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text("Patient Details", 20, 68);

                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                doc.text(`Name: ${patientName}`, 20, 76);
                doc.text(`Age: ${patientAge}`, 80, 76);
                doc.text(`Prescription Date: ${date}`, 140, 76);

                doc.line(20, 84, 190, 84);

                // Medication Details Section
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text(`Medication Details (${medicines.length} found)`, 20, 94);

                let yPos = 104;
                addFooter();

                medicines.forEach((med, index) => {
                    if (yPos > 260) {
                        doc.addPage();
                        pageNum++;
                        yPos = 20;
                        addFooter();
                    }

                    const name = med.Medicine_name || med.medications || med.name || med.drug_name || med.medicine || "Unknown";
                    const dosage = med.Dosage || med.dosage || med.dose || med.strength || "N/A";
                    const freq = med.Frequency || med.frequency || med.schedule || med.timing || "N/A";
                    const duration = med.Duration || med.duration || "As prescribed";

                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text(`${index + 1}. ${name}`, 20, yPos);

                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(80);

                    yPos += 6;
                    doc.text(`Dosage: ${dosage}`, 25, yPos);
                    yPos += 5;
                    doc.text(`Frequency: ${freq}`, 25, yPos);
                    yPos += 5;
                    doc.text(`Duration: ${duration}`, 25, yPos);

                    doc.setTextColor(0);
                    yPos += 10;
                });

                doc.save("MediGrid_Report.pdf");
            }

            function saveToDb() {
                if (!currentAnalyticData) return showToast("No active analysis.");
                fetchWithRetry("/post_into_db", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(currentAnalyticData)
                }, 3, 15000).then(() => showToast("Archived in secure vault.")).catch(() => showToast("Save failed. Please retry."));
            }

            // Leaflet Map Functions
            let map = null;
            let travelMode = 'driving'; // Default travel mode
            let pharmacyMarkers = []; // Store all pharmacy markers
            let nearestPharmacy = null; // Track nearest pharmacy

            // Distance calculation using Haversine formula
            function calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 6371; // Earth's radius in km
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLon = (lon2 - lon1) * Math.PI / 180;
                const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon / 2) * Math.sin(dLon / 2);
                const c = 2 * Math.asin(Math.sqrt(a));
                return R * c; // Distance in km
            }

            // Calculate travel time based on mode
            function calculateTravelTime(distanceKm, mode) {
                const speed = mode === 'driving' ? 40 : 5; // 40 km/h driving, 5 km/h walking
                return Math.round((distanceKm / speed) * 60); // Time in minutes
            }

            // Toggle travel mode
            function setTravelMode(mode) {
                travelMode = mode;

                // Update button styles
                const btnDriving = document.getElementById('btnDriving');
                const btnWalking = document.getElementById('btnWalking');

                if (mode === 'driving') {
                    btnDriving.className = 'flex-1 flex items-center justify-center gap-2 px-4 py-2 rounded-xl bg-primary text-white text-xs font-bold shadow-sm transition-all';
                    btnWalking.className = 'flex-1 flex items-center justify-center gap-2 px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 text-xs font-bold transition-all';
                } else {
                    btnWalking.className = 'flex-1 flex items-center justify-center gap-2 px-4 py-2 rounded-xl bg-primary text-white text-xs font-bold shadow-sm transition-all';
                    btnDriving.className = 'flex-1 flex items-center justify-center gap-2 px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 text-xs font-bold transition-all';
                }

                // Refresh pharmacy markers with new travel times
                if (pharmacyMarkers.length > 0) {
                    updatePharmacyPopups();
                }
            }

            // Update all pharmacy popup content with new travel times
            function updatePharmacyPopups() {
                pharmacyMarkers.forEach(markerData => {
                    const travelTime = calculateTravelTime(markerData.distance, travelMode);
                    const popupContent = createPopupContent(
                        markerData.name,
                        markerData.distance,
                        travelTime,
                        markerData.lat,
                        markerData.lon
                    );
                    markerData.marker.setPopupContent(popupContent);
                });
            }

            // Create popup content HTML
            function createPopupContent(name, distance, travelTime, pharmacyLat, pharmacyLon) {
                const modeText = travelMode === 'driving' ? 'driving' : 'walking';
                const mapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${coords.latitude},${coords.longitude}&destination=${pharmacyLat},${pharmacyLon}&travelmode=${travelMode}`;

                return `
                <div style="font-family: Inter, sans-serif; min-width: 180px;">
                    <strong style="color: #3b82f6; font-size: 14px;">${name}</strong>
                    <div style="margin: 8px 0; padding: 6px 0; border-top: 1px solid #e2e8f0; border-bottom: 1px solid #e2e8f0;">
                        <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                            <span style="font-size: 11px; color: #64748b;"> Distance:</span>
                            <span style="font-size: 11px; font-weight: 600; color: #334155;">${distance.toFixed(2)} km</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <span style="font-size: 11px; color: #64748b;">${travelMode === 'driving' ? '' : ''} Time:</span>
                            <span style="font-size: 11px; font-weight: 600; color: #334155;">~${travelTime} mins</span>
                        </div>
                    </div>
                    <a href="${mapsUrl}" target="_blank" 
                        style="display: block; margin: 8px 0 4px 0; padding: 6px 12px; background: #10b981; color: white; text-align: center; text-decoration: none; border-radius: 8px; font-size: 11px; font-weight: 600;">
                        Get Directions
                    </a>
                    <p style="margin: 6px 0 0 0; font-size: 10px; color: #94a3b8; font-style: italic; text-align: center;">
                        Medicine availability may vary
                    </p>
                </div>
            `;
            }

            function initializeMap() {
                // Only initialize if location is available
                if (!coords) {
                    showToast("Enable location to view nearby pharmacies.");
                    return;
                }

                // Show map container
                document.getElementById('mapContainer').classList.remove('hidden');

                // Prevent re-initialization
                if (map !== null) {
                    map.remove();
                }

                // Initialize Leaflet map
                map = L.map('map').setView([coords.latitude, coords.longitude], 14);

                // Add OpenStreetMap tiles
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    maxZoom: 19
                }).addTo(map);

                // Add user location marker
                const userIcon = L.divIcon({
                    className: 'user-location-marker',
                    html: '<div style="background: #10b981; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>',
                    iconSize: [16, 16],
                    iconAnchor: [8, 8]
                });

                L.marker([coords.latitude, coords.longitude], { icon: userIcon })
                    .addTo(map)
                    .bindPopup('<strong>Your Location</strong>')
                    .openPopup();

                // Search for nearby pharmacies
                searchNearbyPharmacies(coords.latitude, coords.longitude);
            }

            async function searchNearbyPharmacies(lat, lon) {
                const radius = 3000; // 3km in meters

                // Overpass API query for pharmacies
                const query = `
                [out:json][timeout:25];
                (
                    node["amenity"="pharmacy"](around:${radius},${lat},${lon});
                    way["amenity"="pharmacy"](around:${radius},${lat},${lon});
                );
                out center;
            `;

                const overpassUrl = 'https://overpass-api.de/api/interpreter';

                try {
                    const response = await fetch(overpassUrl, {
                        method: 'POST',
                        body: 'data=' + encodeURIComponent(query)
                    });

                    const data = await response.json();

                    if (data.elements && data.elements.length > 0) {
                        addPharmacyMarkers(data.elements);
                        showToast(`Found ${data.elements.length} pharmacies nearby.`);
                    } else {
                        showToast("No pharmacies found in 3km radius.");
                    }
                } catch (error) {
                    console.error('Error fetching pharmacies:', error);
                    showToast("Unable to load pharmacy locations.");
                }
            }

            function addPharmacyMarkers(pharmacies) {
                // Clear previous pharmacy markers
                pharmacyMarkers = [];

                // Calculate distances for all pharmacies
                const pharmaciesWithDistance = pharmacies.map(pharmacy => {
                    const lat = pharmacy.lat || pharmacy.center?.lat;
                    const lon = pharmacy.lon || pharmacy.center?.lon;

                    if (lat && lon) {
                        const distance = calculateDistance(coords.latitude, coords.longitude, lat, lon);
                        return {
                            ...pharmacy,
                            lat,
                            lon,
                            distance,
                            name: pharmacy.tags?.name || 'Pharmacy'
                        };
                    }
                    return null;
                }).filter(p => p !== null);

                // Sort by distance to find nearest
                pharmaciesWithDistance.sort((a, b) => a.distance - b.distance);

                // Create markers for each pharmacy
                pharmaciesWithDistance.forEach((pharmacy, index) => {
                    const isNearest = index === 0;

                    // Different icon for nearest pharmacy (green/orange)
                    const iconColor = isNearest ? '#f97316' : '#3b82f6'; // Orange for nearest, blue for others
                    const pharmacyIcon = L.divIcon({
                        className: 'pharmacy-marker',
                        html: `<div style="background: ${iconColor}; color: white; width: ${isNearest ? 28 : 24}px; height: ${isNearest ? 28 : 24}px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: ${isNearest ? 16 : 14}px; border: ${isNearest ? 3 : 2}px solid white; box-shadow: 0 ${isNearest ? 4 : 2}px ${isNearest ? 12 : 8}px rgba(0,0,0,0.${isNearest ? 4 : 3});"></div>`,
                        iconSize: [isNearest ? 28 : 24, isNearest ? 28 : 24],
                        iconAnchor: [isNearest ? 14 : 12, isNearest ? 14 : 12],
                        popupAnchor: [0, isNearest ? -14 : -12]
                    });

                    // Calculate travel time
                    const travelTime = calculateTravelTime(pharmacy.distance, travelMode);

                    // Create popup content
                    const popupContent = createPopupContent(
                        pharmacy.name,
                        pharmacy.distance,
                        travelTime,
                        pharmacy.lat,
                        pharmacy.lon
                    );

                    // Create and add marker
                    const marker = L.marker([pharmacy.lat, pharmacy.lon], { icon: pharmacyIcon })
                        .addTo(map)
                        .bindPopup(popupContent);

                    // Store marker data for later updates
                    pharmacyMarkers.push({
                        marker,
                        name: pharmacy.name,
                        distance: pharmacy.distance,
                        lat: pharmacy.lat,
                        lon: pharmacy.lon
                    });

                    // Auto-open popup for nearest pharmacy
                    if (isNearest) {
                        nearestPharmacy = pharmacy;
                        marker.openPopup();
                    }
                });
            }

            // Medicine Reminder System
            let currentReminderMedicine = null;

            // Open reminder modal with medicine data
            function openReminderModal(medicine) {
                currentReminderMedicine = medicine;

                // Populate modal with medicine details
                document.getElementById('reminderMedicineName').textContent = medicine.medications || 'Medicine';
                document.getElementById('reminderDosage').textContent = medicine.Dosage || 'N/A';
                const freqStr = medicine.Frequency || 'N/A';
                document.getElementById('reminderFrequency').textContent = freqStr;
                document.getElementById('reminderDuration').textContent = medicine.Duration || 'N/A';

                // Auto-fill suggested times based on frequency string
                const timeInputsContainer = document.getElementById('reminderTimeInputs');
                timeInputsContainer.innerHTML = ''; // Clear old

                let suggestedTimes = ['08:00']; // Default 1/day
                const freqLower = freqStr.toLowerCase();

                if (freqLower.includes('twice') || freqLower.includes('two') || freqLower.includes('2')) {
                    suggestedTimes = ['08:00', '20:00']; // 8 AM & 8 PM
                } else if (freqLower.includes('three') || freqLower.includes('thrice') || freqLower.includes('3')) {
                    suggestedTimes = ['08:00', '14:00', '20:00']; // 8 AM, 2 PM, 8 PM
                } else if (freqLower.includes('four') || freqLower.includes('4')) {
                    suggestedTimes = ['08:00', '12:00', '16:00', '20:00'];
                } else if (freqLower.includes('night') || freqLower.includes('bed')) {
                    suggestedTimes = ['21:00'];
                }

                suggestedTimes.forEach((time, index) => {
                    timeInputsContainer.innerHTML += `
                    <div class="relative">
                        <input type="time" id="reminderTime_${index}" value="${time}" class="reminder-time-val bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 text-slate-800 dark:text-white text-xs rounded-xl px-3 py-2 focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all cursor-pointer">
                    </div>
                `;
                });

                // Show mobile option if on mobile device
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                const mobileBtn = document.getElementById('mobileQuickAddBtn');
                if (isMobile && mobileBtn) {
                    mobileBtn.classList.remove('hidden');
                }

                // Show modal
                document.getElementById('reminderModal').classList.remove('hidden');
            }

            // Close reminder modal
            function closeReminderModal() {
                document.getElementById('reminderModal').classList.add('hidden');
                currentReminderMedicine = null;
            }

            // Removed static getTimeFromFrequency, dynamically reading inputs instead.

            // Extract duration in days
            function getDurationDays(durationStr) {
                const duration = (durationStr || '').toLowerCase();

                // Match patterns like "5 days", "1 week", "2 months"
                const daysMatch = duration.match(/(\d+)\s*day/i);
                if (daysMatch) return parseInt(daysMatch[1]);

                const weeksMatch = duration.match(/(\d+)\s*week/i);
                if (weeksMatch) return parseInt(weeksMatch[1]) * 7;

                const monthsMatch = duration.match(/(\d+)\s*month/i);
                if (monthsMatch) return parseInt(monthsMatch[1]) * 30;

                // Default to 7 days
                return 7;
            }

            // Format date for .ics (YYYYMMDDTHHMMSS)
            function formatDateForICS(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                const seconds = String(date.getSeconds()).padStart(2, '0');
                return `${year}${month}${day}T${hours}${minutes}${seconds}`;
            }

            // Generate and download .ics file
            function downloadICSReminder() {
                if (!currentReminderMedicine) return;

                const medicine = currentReminderMedicine;
                const medicineName = medicine.medications || 'Medicine';
                const dosage = medicine.Dosage || '';
                const frequency = medicine.Frequency || '';
                const durationDays = getDurationDays(medicine.Duration);

                // Get user-edited times from DOM
                const timeInputs = document.querySelectorAll('.reminder-time-val');
                let baseTimes = [];
                timeInputs.forEach(input => {
                    const [hr, min] = input.value.split(':');
                    baseTimes.push({ h: parseInt(hr), m: parseInt(min) });
                });
                if (baseTimes.length === 0) baseTimes.push({ h: 8, m: 0 });

                // Ensure start date is tomorrow to avoid missing today's past reminders
                let now = new Date();
                let startDate = new Date(now);
                startDate.setDate(startDate.getDate() + 1);

                let icsEvents = [];
                const uidBase = Date.now().toString() + "@medigrid.ai";
                let eventCount = 0;

                // Loop through each day up to the estimated duration
                for (let dayOffset = 0; dayOffset < durationDays; dayOffset++) {
                    // For each day, create an event for every time slot requested
                    baseTimes.forEach(timeSlot => {
                        let evStart = new Date(startDate);
                        evStart.setDate(evStart.getDate() + dayOffset);
                        evStart.setHours(timeSlot.h, timeSlot.m, 0, 0);

                        let evEnd = new Date(evStart);
                        evEnd.setHours(evStart.getHours() + 1); // 1-hour window

                        const startStr = formatDateForICS(evStart);
                        const endStr = formatDateForICS(evEnd);
                        const dtStamp = formatDateForICS(now);
                        const summary = `Take ${medicineName} ${dosage}`;
                        const description = `Medicine Reminder from MediGrid AI\\n\\nDosage: ${dosage}\\nFrequency: ${frequency}\\nDuration: ${medicine.Duration || 'As prescribed'}\\n\\nPlease take your medicine as prescribed.`;

                        const eventStr = [
                            "BEGIN:VEVENT",
                            `UID:${uidBase}-${eventCount++}`,
                            `DTSTAMP:${dtStamp}`,
                            `DTSTART:${startStr}`,
                            `DTEND:${endStr}`,
                            `SUMMARY:${summary}`,
                            `DESCRIPTION:${description}`,
                            "BEGIN:VALARM",
                            "TRIGGER:-PT15M", // Alert 15 mins before
                            "ACTION:DISPLAY",
                            `DESCRIPTION:Reminder: ${summary}`,
                            "END:VALARM",
                            "END:VEVENT"
                        ].join("\r\n");

                        icsEvents.push(eventStr);
                    });
                }

                const icsContent = [
                    "BEGIN:VCALENDAR",
                    "VERSION:2.0",
                    "PRODID:-//MediGrid AI//Prescription Tracker//EN",
                    "CALSCALE:GREGORIAN",
                    "METHOD:PUBLISH",
                    ...icsEvents,
                    "END:VCALENDAR"
                ].join("\r\n");

                // Create blob and download
                const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `${medicineName.replace(/\s+/g, '_')}_reminder.ics`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                showToast(` Reminder file downloaded! Open it to add to your calendar.`);
                closeReminderModal();
            }

            // Open Google Calendar
            function openGoogleCalendarReminder() {
                if (!currentReminderMedicine) return;

                const medicine = currentReminderMedicine;
                const medicineName = medicine.medications || 'Medicine';
                const dosage = medicine.Dosage || '';
                const frequency = medicine.Frequency || '';
                const durationDays = getDurationDays(medicine.Duration);

                // Get user-edited times from DOM. We rely on the first entry for simple web-links
                const timeInputs = document.querySelectorAll('.reminder-time-val');
                let h = 8, m = 0;
                if (timeInputs.length > 0) {
                    const parts = timeInputs[0].value.split(':');
                    h = parseInt(parts[0]);
                    m = parseInt(parts[1]);
                }

                // Create start date (tomorrow at specified time)
                const startDate = new Date();
                startDate.setDate(startDate.getDate() + 1);
                startDate.setHours(h, m, 0, 0);

                // Create end date (30 minutes later)
                const endDate = new Date(startDate);
                endDate.setMinutes(endDate.getMinutes() + 30);

                // Format dates for Google Calendar (ISO format without separators)
                const formatForGoogle = (date) => {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    const seconds = String(date.getSeconds()).padStart(2, '0');
                    return `${year}${month}${day}T${hours}${minutes}${seconds}Z`;
                };

                // Build Google Calendar URL
                const title = encodeURIComponent(`Take ${medicineName} ${dosage}`);
                const details = encodeURIComponent(`Medicine Reminder from MediGrid AI\n\nDosage: ${dosage}\nFrequency: ${frequency}\nDuration: ${medicine.Duration || 'As prescribed'}\n\nPlease take your medicine as prescribed.`);
                const dates = `${formatForGoogle(startDate)}/${formatForGoogle(endDate)}`;
                const recur = encodeURIComponent(`RRULE:FREQ=DAILY;COUNT=${durationDays}`);

                const googleCalendarUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&details=${details}&dates=${dates}&recur=${recur}`;

                // Open in new tab
                window.open(googleCalendarUrl, '_blank');

                showToast(` Google Calendar opened! Save the event to add reminder.`);
                closeReminderModal();
            }

            // Mobile quick add (fallback)
            function mobileQuickAdd() {
                if (!currentReminderMedicine) return;

                const isAndroid = /Android/i.test(navigator.userAgent);
                const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);

                if (isAndroid) {
                    // Android calendar intent
                    window.location.href = 'intent://calendar.google.com/#Intent;scheme=https;end;';
                    showToast(` Opening calendar app...`);
                } else if (isIOS) {
                    // iOS webcal protocol
                    showToast(` Please use the "Save to Phone Calendar" option for best results on iOS.`);
                } else {
                    showToast(` Please use the desktop options above.`);
                }

                closeReminderModal();
            }

            // STEP 4: Initialize Secure Context Badge
            function updateSecureContextBadge() {
                const badge = document.getElementById('secureContextBadge');
                const icon = document.getElementById('secureIcon');
                const txt = document.getElementById('secureTxt');

                if (window.isSecureContext) {
                    badge.classList.remove('hidden');
                    badge.classList.add('bg-emerald-50', 'dark:bg-emerald-900/20', 'border-emerald-200', 'dark:border-emerald-800', 'text-emerald-600', 'dark:text-emerald-400');
                    badge.classList.remove('bg-rose-50', 'dark:bg-rose-900/20', 'border-rose-200', 'dark:border-rose-800', 'text-rose-600', 'dark:text-rose-400');
                    icon.textContent = 'verified';
                    txt.textContent = 'Secure Context';
                } else {
                    badge.classList.remove('hidden');
                    badge.classList.add('bg-rose-50', 'dark:bg-rose-900/20', 'border-rose-200', 'dark:border-rose-800', 'text-rose-600', 'dark:text-rose-400');
                    badge.classList.remove('bg-emerald-50', 'dark:bg-emerald-900/20', 'border-emerald-200', 'dark:border-emerald-800', 'text-emerald-600', 'dark:text-emerald-400');
                    icon.textContent = 'warning';
                    txt.textContent = 'Insecure Origin';
                }
            }

            // --- Interactive Onboarding Tour ---
            const tourSteps = [
                { id: 'locBtn', text: 'Step 1: Enable your location to find nearby pharmacies.', action: () => { toggleSidebar('left', true); } },
                { id: 'uploadCardBtn', text: 'Step 2: Upload a clear image of your prescription.', action: () => { toggleSidebar('left', false); closeAllDrawers(); } },
                { id: 'scanPrescriptionBtn', text: 'Step 3: Or scan directly using your mobile camera.' },
                { id: 'resultsContainer', text: 'Step 4: View medications and safety warnings here.', pre: () => { document.getElementById('resultsContainer').classList.remove('hidden'); }, post: () => { document.getElementById('resultsContainer').classList.add('hidden'); } }
            ];

            let currentTourStep = 0;
            let tourActive = false;

            document.addEventListener('DOMContentLoaded', () => {
                if (!localStorage.getItem('medigridTourCompleted')) {
                    setTimeout(startTour, 1500);
                }
            });

            document.addEventListener('keydown', (e) => {
                if (!tourActive) return;
                if (e.key === 'ArrowRight') tourNext();
                else if (e.key === 'ArrowLeft') tourPrev();
                else if (e.key === 'Escape') endTour();
            });

            function createTourOverlay() {
                if (document.getElementById('tourOverlay')) return;
                const html = `
            <div id="tourOverlay" class="fixed inset-0 transition-opacity duration-500 opacity-0 pointer-events-none" style="background: rgba(15, 23, 42, 0.65); z-index: 9998;">
                <div id="tourSpotlight" class="absolute shadow-[0_0_20px_4px_rgba(16,185,129,0.5),0_0_0_9999px_rgba(15,23,42,0.8)] transition-all duration-500 pointer-events-none z-[101]"></div>
                <div id="tourTooltip" class="absolute bg-white dark:bg-slate-800 p-5 rounded-2xl w-[90%] md:w-[320px] shadow-2xl border border-primary/30 transition-all duration-500 transform scale-95 opacity-0 z-[102] pointer-events-auto">
                    <div id="tourArrow" class="absolute w-4 h-4 bg-white dark:bg-slate-800 transform rotate-45 transition-all duration-300"></div>
                    <div class="flex justify-between items-center mb-3">
                        <span id="tourProgress" class="text-[10px] font-bold uppercase tracking-widest text-primary"></span>
                        <button onclick="endTour()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200"><span class="material-symbols-rounded text-sm">close</span></button>
                    </div>
                    <p id="tourText" class="text-sm font-bold text-slate-800 dark:text-white mb-6 leading-relaxed"></p>
                    <div class="flex justify-between items-center mt-2">
                        <button id="tourSkipBtn" onclick="endTour()" class="text-xs font-bold text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition-colors">Skip</button>
                        <div class="flex gap-2">
                            <button id="tourPrevBtn" onclick="tourPrev()" class="px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-800 text-xs font-bold hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">Prev</button>
                            <button id="tourNextBtn" onclick="tourNext()" class="px-5 py-2 rounded-xl bg-gradient-to-r from-primary to-secondary text-white text-xs font-bold shadow-lg shadow-primary/30 hover:shadow-primary/50 hover:-translate-y-0.5 transition-all">Next</button>
                        </div>
                    </div>
                </div>
            </div>`;
                document.body.insertAdjacentHTML('beforeend', html);
            }

            function startTour() {
                tourActive = true;
                currentTourStep = 0;
                createTourOverlay();

                document.body.classList.add('tour-active');
                document.body.style.overflow = 'hidden';

                const overlay = document.getElementById('tourOverlay');
                overlay.classList.remove('hidden');
                void overlay.offsetWidth;
                overlay.classList.remove('opacity-0', 'pointer-events-none');
                overlay.classList.add('opacity-100', 'pointer-events-auto');
                showTourStep();
            }

            function endTour(isFinish = false) {
                tourActive = false;
                localStorage.setItem('medigridTourCompleted', 'true');

                const overlay = document.getElementById('tourOverlay');
                if (overlay) {
                    overlay.classList.remove('opacity-100', 'pointer-events-auto');
                    overlay.classList.add('opacity-0', 'pointer-events-none');
                    setTimeout(() => overlay.remove(), 500);
                }

                document.body.classList.remove('tour-active');
                document.body.style.overflow = '';

                document.querySelectorAll('.tour-highlight').forEach(el => {
                    el.classList.remove('tour-highlight', 'relative', 'z-[200]', 'z-[10000]', 'rounded-2xl', 'rounded-3xl', 'bg-white', 'p-4', 'dark:bg-slate-900', 'transition-all', 'duration-500');
                    el.style.removeProperty('z-index');
                    el.style.removeProperty('position');
                    el.style.removeProperty('background-color');
                });

                if (tourSteps[currentTourStep]?.post) tourSteps[currentTourStep].post();
                toggleSidebar('left', false);
                closeAllDrawers();

                if (isFinish) {
                    window.location.reload();
                }
            }

            function showTourStep() {
                document.querySelectorAll('.tour-highlight').forEach(el => {
                    el.classList.remove('tour-highlight', 'relative', 'z-[200]', 'z-[10000]', 'rounded-2xl', 'rounded-3xl', 'bg-white', 'p-4', 'dark:bg-slate-900', 'transition-all', 'duration-500');
                    el.style.removeProperty('z-index');
                    el.style.removeProperty('position');
                });
                if (currentTourStep > 0 && tourSteps[currentTourStep - 1].post) tourSteps[currentTourStep - 1].post();

                // Handle progress text
                document.getElementById('tourProgress').textContent = `Step ${currentTourStep + 1} of ${tourSteps.length}`;

                const step = tourSteps[currentTourStep];
                if (step.pre) step.pre();
                if (step.action) step.action();

                const target = document.getElementById(step.id);
                if (!target) return endTour();

                target.scrollIntoView({ behavior: 'smooth', block: 'center' });

                const roundedClass = step.id === 'uploadCardBtn' ? 'rounded-3xl' : 'rounded-2xl';
                target.classList.add('tour-highlight', 'relative', 'z-[10000]', roundedClass, 'transition-all', 'duration-500');

                if (step.id === 'resultsContainer') target.classList.add('bg-white', 'p-4', 'dark:bg-slate-900');

                const tooltip = document.getElementById('tourTooltip');
                const arrow = document.getElementById('tourArrow');
                document.getElementById('tourText').textContent = step.text;

                tooltip.classList.remove('opacity-100', 'scale-100');
                tooltip.classList.add('opacity-0', 'scale-95');

                setTimeout(() => {
                    const rect = target.getBoundingClientRect();
                    const tooltipRect = tooltip.getBoundingClientRect();

                    let top = rect.bottom + 20;
                    let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
                    let placeTooltip = 'bottom';

                    // Position Spotlight
                    const spot = document.getElementById('tourSpotlight');
                    const padding = 12;
                    spot.style.width = `${rect.width + padding * 2}px`;
                    spot.style.height = `${rect.height + padding * 2}px`;
                    spot.style.top = `${rect.top - padding}px`;
                    spot.style.left = `${rect.left - padding}px`;
                    spot.style.borderRadius = step.id === 'uploadCardBtn' ? '2rem' : '1.5rem';

                    // Positioning
                    if (top + tooltipRect.height > window.innerHeight) {
                        top = rect.top - tooltipRect.height - 20;
                        placeTooltip = 'top';
                    }
                    if (left < 20) left = 20;
                    if (left + tooltipRect.width > window.innerWidth - 20) left = window.innerWidth - tooltipRect.width - 20;

                    tooltip.style.top = `${top}px`;
                    tooltip.style.left = `${left}px`;
                    tooltip.classList.remove('opacity-0', 'scale-95');
                    tooltip.classList.add('opacity-100', 'scale-100');

                    // Arrow
                    if (placeTooltip === 'bottom') {
                        arrow.style.top = '-8px';
                        arrow.style.bottom = 'auto';
                        let arrowLeft = rect.left + rect.width / 2 - left - 8;
                        if (arrowLeft < 15) arrowLeft = 15;
                        if (arrowLeft > tooltipRect.width - 25) arrowLeft = tooltipRect.width - 25;
                        arrow.style.left = `${arrowLeft}px`;
                        arrow.className = 'absolute w-4 h-4 bg-white dark:bg-slate-800 border-l border-t border-slate-200/60 dark:border-slate-700/40 transform rotate-45 transition-all duration-300';
                    } else {
                        arrow.style.bottom = '-8px';
                        arrow.style.top = 'auto';
                        let arrowLeft = rect.left + rect.width / 2 - left - 8;
                        if (arrowLeft < 15) arrowLeft = 15;
                        if (arrowLeft > tooltipRect.width - 25) arrowLeft = tooltipRect.width - 25;
                        arrow.style.left = `${arrowLeft}px`;
                        arrow.className = 'absolute w-4 h-4 bg-white dark:bg-slate-800 border-r border-b border-slate-200/60 dark:border-slate-700/40 transform rotate-45 transition-all duration-300';
                    }

                }, 350);

                document.getElementById('tourPrevBtn').style.display = currentTourStep === 0 ? 'none' : 'block';
                document.getElementById('tourNextBtn').textContent = currentTourStep === tourSteps.length - 1 ? 'Finish' : 'Next';
            }

            function tourNext() {
                if (currentTourStep < tourSteps.length - 1) {
                    currentTourStep++;
                    showTourStep();
                } else {
                    endTour(true);
                }
            }

            function tourPrev() {
                if (currentTourStep > 0) {
                    currentTourStep--;
                    showTourStep();
                }
            }

            // Initialize badge on page load
            window.addEventListener('DOMContentLoaded', updateSecureContextBadge);

            // Restart Tour Functions
            function confirmRestartTour() {
                toggleSidebar('left', false);
                document.getElementById('restartTourModal').classList.remove('hidden');
            }

            function cancelRestartTour() {
                document.getElementById('restartTourModal').classList.add('hidden');
            }

            function restartTour() {
                cancelRestartTour();
                localStorage.removeItem('medigridTourCompleted');
                setTimeout(startTour, 300);
            }
        </script>
        <!-- Modern Light Footer -->
        <footer class="footer">
            <h3>MediGrid AI v2.5.1</h3>
            <p>Made by <span style="font-weight: 800;">hrohit12</span></p>

            <div class="social-icons">
                <a href="https://www.linkedin.com/in/hrohit12/" target="_blank" class="social-btn linkedin-btn">
                    <svg style="width: 20px; height: 20px;" viewBox="0 0 24 24">
                        <path
                            d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z" />
                    </svg>
                </a>

                <a href="https://github.com/hrohit12" target="_blank" class="social-btn github-btn">
                    <svg style="width: 20px; height: 20px;" viewBox="0 0 24 24">
                        <path
                            d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z" />
                    </svg>
                </a>
            </div>
        </footer>
    </div>
</body>

</html>
